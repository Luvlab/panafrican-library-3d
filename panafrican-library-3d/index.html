<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Panafrican Library Will Not Be Colonized | Reading Room 3D</title>
    <meta name="description" content="A curatorial Reading Room conceived as a living archive of panafrican and diasporic publishing. Interactive 3D simulation.">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
            overflow: hidden;
        }
        #canvas-container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        #info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.85);
            padding: 20px;
            border-radius: 8px;
            max-width: 320px;
            z-index: 100;
            border: 1px solid rgba(255,255,255,0.1);
        }
        /* Mobile responsive styles */
        @media (max-width: 768px) {
            #info-panel {
                top: 10px;
                left: 10px;
                right: 10px;
                max-width: none;
                padding: 12px;
            }
            #info-panel h1 { font-size: 14px; }
            #info-panel h2 { font-size: 9px; margin-bottom: 10px; }
            #info-panel p { font-size: 11px; margin-bottom: 10px; }
            .room-btn { padding: 6px 10px; font-size: 10px; }
            #controls-panel {
                top: auto;
                bottom: 180px;
                right: 10px;
                left: 10px;
                max-height: 40vh;
                display: flex;
                flex-wrap: wrap;
                gap: 5px;
                padding: 10px;
            }
            .control-section {
                flex: 1 1 45%;
                min-width: 140px;
                margin-bottom: 5px;
                padding-bottom: 5px;
            }
            .control-btn { padding: 6px 8px; font-size: 10px; }
            .section-title { font-size: 9px; margin-bottom: 5px; }
            #dimensions-panel { display: none; }
            #credits {
                bottom: 10px;
                right: 10px;
                left: auto;
                padding: 8px 10px;
                font-size: 8px;
            }
            #help-text {
                bottom: 150px;
                font-size: 10px;
                padding: 6px 12px;
            }
            #toggle-btns {
                bottom: 100px;
                padding: 0 10px;
            }
            .toggle-btn { padding: 5px 8px; font-size: 9px; }
            #capture-btn {
                bottom: 60px;
                padding: 8px 15px;
                font-size: 11px;
            }
        }
        @media (max-width: 480px) {
            #info-panel {
                padding: 10px;
            }
            #info-panel h1 { font-size: 12px; }
            #info-panel p { display: none; }
            #controls-panel {
                max-height: 35vh;
            }
            .control-section { flex: 1 1 100%; }
            #credits { display: none; }
        }
        #info-panel h1 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        #info-panel h2 {
            font-size: 11px;
            font-weight: 400;
            color: #888;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        #info-panel p {
            font-size: 13px;
            line-height: 1.6;
            color: #ccc;
            margin-bottom: 15px;
        }
        .room-btn {
            display: inline-block;
            padding: 8px 14px;
            margin: 4px 4px 4px 0;
            background: rgba(100, 149, 237, 0.3);
            border: 1px solid cornflowerblue;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }
        .room-btn:hover {
            background: cornflowerblue;
        }
        #controls-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.85);
            padding: 15px;
            border-radius: 8px;
            z-index: 100;
            border: 1px solid rgba(255,255,255,0.1);
            max-height: 80vh;
            overflow-y: auto;
        }
        .control-section {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .control-section:last-child { border-bottom: none; }
        .section-title {
            font-size: 10px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        .control-btn {
            display: block;
            width: 100%;
            padding: 8px 12px;
            margin: 4px 0;
            background: rgba(255,255,255,0.1);
            border: none;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            text-align: left;
            transition: all 0.3s;
        }
        .control-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        .control-btn.active {
            background: rgba(100, 149, 237, 0.4);
            border: 1px solid cornflowerblue;
        }
        #dimensions-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.85);
            padding: 15px;
            border-radius: 8px;
            z-index: 100;
            border: 1px solid rgba(255,255,255,0.1);
            font-size: 11px;
            max-width: 420px;
        }
        #dimensions-panel h3 {
            font-size: 12px;
            margin-bottom: 10px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .dim-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .dim-row:last-child { border-bottom: none; }
        .dim-label { color: #888; }
        .dim-value { color: #fff; font-family: monospace; }
        #credits {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.85);
            padding: 12px 15px;
            border-radius: 8px;
            z-index: 100;
            border: 1px solid rgba(255,255,255,0.1);
            font-size: 10px;
            text-align: right;
        }
        #credits a { color: cornflowerblue; text-decoration: none; }
        #credits a:hover { text-decoration: underline; }
        #help-text {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 12px;
            color: #888;
            z-index: 100;
        }
        #toggle-btns {
            position: absolute;
            bottom: 130px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
            z-index: 100;
            max-width: 500px;
        }
        .toggle-btn {
            padding: 6px 12px;
            background: rgba(0,0,0,0.7);
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }
        .toggle-btn.active {
            background: rgba(100, 149, 237, 0.5);
            border-color: cornflowerblue;
        }
        #capture-btn {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            background: cornflowerblue;
            border: none;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            z-index: 100;
        }
        .icon { margin-right: 6px; }
        #moodboard-btn {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(calc(-50% + 80px));
            padding: 10px 20px;
            background: #8b2942;
            border: none;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            z-index: 100;
        }
        #moodboard-btn:hover { background: #a03050; }
        #capture-btn { transform: translateX(calc(-50% - 80px)); }
        .modal-hidden { display: none; }
        #moodboard-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            overflow-y: auto;
            padding: 40px 20px;
        }
        .modal-content {
            max-width: 900px;
            margin: 0 auto;
            background: #1a1a1a;
            border-radius: 12px;
            padding: 30px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .modal-close {
            position: absolute;
            top: 20px;
            right: 30px;
            background: none;
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
        }
        .modal-content h2 {
            font-size: 24px;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .modal-content > p {
            color: #888;
            margin-bottom: 25px;
            font-size: 14px;
        }
        .moodboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        .moodboard-section {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 8px;
        }
        .moodboard-section h3 {
            font-size: 14px;
            color: cornflowerblue;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .image-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .ref-image {
            aspect-ratio: 4/3;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .ref-image span {
            background: rgba(0,0,0,0.6);
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 11px;
        }
        .color-palette {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .color-swatch {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .color-swatch:hover { transform: scale(1.1); }
        .design-list {
            list-style: none;
            font-size: 13px;
            line-height: 2;
        }
        .layout-info p {
            font-size: 12px;
            line-height: 1.8;
            color: #ccc;
            margin-bottom: 10px;
        }
        @media (max-width: 768px) {
            #capture-btn, #moodboard-btn {
                transform: translateX(-50%);
                bottom: 20px;
            }
            #moodboard-btn { bottom: 60px; }
            .modal-content { padding: 20px; }
            .moodboard-grid { grid-template-columns: 1fr; }
        }
        /* Decorator Mode Styles */
        #decorator-btn {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(calc(-50% + 180px));
            padding: 10px 20px;
            background: #20c997;
            border: none;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            z-index: 100;
        }
        #decorator-btn:hover { background: #1aa87c; }
        #decorator-panel {
            position: fixed;
            top: 0;
            right: -350px;
            width: 350px;
            height: 100%;
            background: rgba(20,20,20,0.98);
            z-index: 1001;
            transition: right 0.3s ease;
            overflow-y: auto;
            border-left: 1px solid rgba(255,255,255,0.1);
        }
        #decorator-panel.open { right: 0; }
        .decorator-header {
            padding: 20px;
            background: rgba(0,0,0,0.5);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .decorator-header h2 { font-size: 16px; margin: 0; }
        .decorator-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
        }
        .decorator-category {
            padding: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .decorator-category h3 {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #20c997;
            margin-bottom: 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .decorator-category h3::after { content: '‚ñº'; font-size: 8px; }
        .decorator-category.collapsed h3::after { content: '‚ñ∂'; }
        .decorator-category.collapsed .item-grid { display: none; }
        .item-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        .item-card {
            background: rgba(255,255,255,0.08);
            border-radius: 6px;
            padding: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .item-card:hover { background: rgba(255,255,255,0.15); }
        .item-card.selected { border-color: #20c997; background: rgba(32,201,151,0.2); }
        .item-preview {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 4px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        .item-name {
            font-size: 9px;
            color: #ccc;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .decorator-actions {
            padding: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .decorator-action-btn {
            flex: 1 1 45%;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
        }
        .decorator-action-btn.primary { background: #20c997; color: #fff; }
        .decorator-action-btn.secondary { background: rgba(255,255,255,0.1); color: #fff; }
        .decorator-action-btn:hover { opacity: 0.8; }
        .decorator-instructions {
            padding: 15px;
            background: rgba(0,0,0,0.3);
            font-size: 11px;
            color: #888;
            line-height: 1.6;
        }
        .decorator-instructions strong { color: #fff; }
        #selected-item-info {
            padding: 15px;
            background: rgba(32,201,151,0.1);
            border-top: 1px solid rgba(32,201,151,0.3);
            display: none;
        }
        #selected-item-info.visible { display: block; }
        #selected-item-info h4 { font-size: 12px; margin-bottom: 8px; }
        .item-controls {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        .item-control-btn {
            padding: 6px 10px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: #fff;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
        }
        .item-control-btn:hover { background: rgba(255,255,255,0.2); }
        .item-control-btn.danger { background: rgba(220,53,69,0.5); }
        .item-control-btn.danger:hover { background: rgba(220,53,69,0.7); }
        /* Wall art section special styling */
        .art-item-card {
            grid-column: span 2;
        }
        .art-item-card .item-preview {
            aspect-ratio: 4/3;
        }
        @media (max-width: 768px) {
            #decorator-btn { transform: translateX(-50%); bottom: 100px; }
            #decorator-panel { width: 100%; right: -100%; }
        }
    </style>
</head>
<body>
    <div id="canvas-container"></div>

    <div id="info-panel">
        <h1>The Panafrican Library Will Not Be Colonized</h1>
        <h2>Reading Room ‚Ä¢ Interactive 3D</h2>
        <p>A curatorial Reading Room conceived as a living archive of panafrican and diasporic publishing. A space to read, listen, and slow down.</p>
        <button class="room-btn" onclick="focusRoom('room5202')">Room 5202 ‚Äî Special Special</button>
        <button class="room-btn" onclick="focusRoom('room5203')">Room 5203 ‚Äî Reading Room</button>
    </div>

    <div id="controls-panel">
        <div class="control-section">
            <div class="section-title">Overview</div>
            <button class="control-btn" onclick="setView('overview')"><span class="icon">üè†</span>Bird's Eye</button>
            <button class="control-btn" onclick="setView('floorPlan')"><span class="icon">üìê</span>Floor Plan View</button>
        </div>
        <div class="control-section">
            <div class="section-title">Room 5202 - Special Special</div>
            <button class="control-btn" onclick="setView('room5202Entry')"><span class="icon">üö™</span>Entry Vestibule</button>
            <button class="control-btn" onclick="setView('room5202Inside')"><span class="icon">üîä</span>Inside View</button>
            <button class="control-btn" onclick="setView('room5202Windows')"><span class="icon">ü™ü</span>Window Wall</button>
            <button class="control-btn" onclick="setView('room5202Table')"><span class="icon">üìö</span>Display Table</button>
        </div>
        <div class="control-section">
            <div class="section-title">Room 5203 - Reading Room</div>
            <button class="control-btn" onclick="setView('room5203Entry')"><span class="icon">üö™</span>Entry (from door)</button>
            <button class="control-btn" onclick="setView('room5203Inside')"><span class="icon">üìñ</span>Inside View</button>
            <button class="control-btn" onclick="setView('room5203Windows')"><span class="icon">ü™ü</span>Arched Windows</button>
            <button class="control-btn" onclick="setView('room5203Seating')"><span class="icon">üõãÔ∏è</span>Seating Area</button>
            <button class="control-btn" onclick="setView('room5203Shelves')"><span class="icon">üìö</span>Book Displays</button>
        </div>
        <div class="control-section">
            <button class="control-btn" onclick="startTour()"><span class="icon">üé¨</span>Auto Tour</button>
        </div>
    </div>

    <div id="dimensions-panel">
        <h3>Room Dimensions (from floor plan)</h3>
        <div class="dim-row">
            <span class="dim-label">Room 5202 (Special Special)</span>
            <span class="dim-value">11'-5‚Öù" √ó 25'-3¬æ" | 3.49m √ó 7.71m</span>
        </div>
        <div class="dim-row">
            <span class="dim-label">Room 5202 Area</span>
            <span class="dim-value">289.4 sq ft | 26.9 m¬≤</span>
        </div>
        <div class="dim-row">
            <span class="dim-label">Room 5203 (Reading Room)</span>
            <span class="dim-value">14'-7¬æ" √ó 25'-3¬æ" | 4.46m √ó 7.71m</span>
        </div>
        <div class="dim-row">
            <span class="dim-label">Room 5203 Area</span>
            <span class="dim-value">369.5 sq ft | 34.3 m¬≤</span>
        </div>
        <div class="dim-row">
            <span class="dim-label">Ceiling Height</span>
            <span class="dim-value">12'-0" | 3.66m</span>
        </div>
        <div class="dim-row">
            <span class="dim-label">Door Openings</span>
            <span class="dim-value">3'-5‚Öõ" √ó 7'-0" | 1.04m √ó 2.13m</span>
        </div>
        <div class="dim-row">
            <span class="dim-label">Total Combined Area</span>
            <span class="dim-value">658.9 sq ft | 61.2 m¬≤</span>
        </div>
    </div>

    <div id="credits">
        <div style="margin-bottom: 8px; color: #888;">A project by</div>
        <div><a href="http://www.afrikadaa.com/" target="_blank">Pascale Obolo / Afrikadaa</a></div>
        <div><a href="http://coolhuntparis.com" target="_blank">Nalini Cazaux / Coolhunt Paris</a></div>
        <div style="margin-top: 8px; color: #888;">3D Simulation by</div>
        <div><a href="http://luvlab.io" target="_blank">Gordon Cyrus / Luvlab</a></div>
    </div>

    <div id="help-text">‚Ä¢ Drag to rotate ‚Ä¢ Scroll to zoom ‚Ä¢ WASD to move</div>

    <div id="toggle-btns">
        <button class="toggle-btn active" onclick="toggleGrid()" id="gridBtn">Grid</button>
        <button class="toggle-btn active" onclick="toggleLabels()" id="labelsBtn">Labels</button>
        <button class="toggle-btn active" onclick="toggleCeiling()" id="ceilingBtn">Ceiling</button>
        <button class="toggle-btn" onclick="toggleNearWall()" id="nearWallBtn">Hide Near Wall</button>
        <button class="toggle-btn" onclick="toggleWireframe()" id="wireframeBtn">Wireframe</button>
    </div>

    <button id="capture-btn" onclick="captureScreenshot()">üì∑ Capture</button>
    <button id="moodboard-btn" onclick="toggleMoodboard()">üé® Mood Board</button>

    <!-- Mood Board Modal -->
    <div id="moodboard-modal" class="modal-hidden">
        <div class="modal-content">
            <button class="modal-close" onclick="toggleMoodboard()">‚úï</button>
            <h2>Reference Images & Mood Board</h2>
            <p>Design inspiration for The Panafrican Library Reading Room</p>
            <div class="moodboard-grid">
                <div class="moodboard-section">
                    <h3>MoMA PS1 Reading Room</h3>
                    <div class="image-grid">
                        <div class="ref-image" style="background: linear-gradient(135deg, #1a3a5c 0%, #2c5282 100%);"><span>Deep Blue Carpet</span></div>
                        <div class="ref-image" style="background: linear-gradient(135deg, #f5f0e8 0%, #e8e3db 100%);"><span>White Walls</span></div>
                        <div class="ref-image" style="background: linear-gradient(135deg, #d4a76a 0%, #c4956a 100%);"><span>Wood Tables</span></div>
                        <div class="ref-image" style="background: linear-gradient(135deg, #87CEEB 0%, #6bb3d9 100%);"><span>Industrial Windows</span></div>
                    </div>
                </div>
                <div class="moodboard-section">
                    <h3>Color Palette</h3>
                    <div class="color-palette">
                        <div class="color-swatch" style="background: #1a3a5c;" title="Navy Blue Carpet"></div>
                        <div class="color-swatch" style="background: #f8f8f5;" title="Off-White Walls"></div>
                        <div class="color-swatch" style="background: #d4a76a;" title="Natural Wood"></div>
                        <div class="color-swatch" style="background: #c41e3a;" title="Red Accents"></div>
                        <div class="color-swatch" style="background: #ffd93d;" title="Yellow Highlights"></div>
                        <div class="color-swatch" style="background: #4ecdc4;" title="Teal Books"></div>
                        <div class="color-swatch" style="background: #c9a227;" title="Ochre Floor"></div>
                        <div class="color-swatch" style="background: #8b2942;" title="Burgundy Rug"></div>
                    </div>
                </div>
                <div class="moodboard-section">
                    <h3>Design Elements</h3>
                    <ul class="design-list">
                        <li>ü™ü Tall industrial windows with white frames</li>
                        <li>üèõÔ∏è White fluted columns between windows</li>
                        <li>üìö Colorful book displays and publications</li>
                        <li>üõãÔ∏è Floor cushions and low seating</li>
                        <li>üé® Poster-covered walls with African diaspora art</li>
                        <li>üåø Potted plants for natural atmosphere</li>
                        <li>üí° Pendant lighting with warm glow</li>
                        <li>üß∂ Layered rugs with African patterns</li>
                    </ul>
                </div>
                <div class="moodboard-section">
                    <h3>Room Layout</h3>
                    <div class="layout-info">
                        <p><strong>Room 5202 - Special Special:</strong> Entry vestibule, display table, listening area</p>
                        <p><strong>Room 5203 - Reading Room:</strong> Poster wall, floor seating, book displays</p>
                        <p><strong>Connection:</strong> Open doorway between rooms</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <button id="decorator-btn" onclick="toggleDecorator()">üõãÔ∏è Decorator</button>

    <!-- Decorator Panel -->
    <div id="decorator-panel">
        <div class="decorator-header">
            <h2>üõãÔ∏è Room Decorator</h2>
            <button class="decorator-close" onclick="toggleDecorator()">‚úï</button>
        </div>

        <div class="decorator-instructions">
            <strong>How to use:</strong> Select an item below, then click in the room to place it. Click placed items to select them for editing.
        </div>

        <div id="selected-item-info">
            <h4>Selected: <span id="selected-name">None</span></h4>
            <div class="item-controls">
                <button class="item-control-btn" onclick="moveItem(-0.2, 0)">‚Üê Move</button>
                <button class="item-control-btn" onclick="moveItem(0.2, 0)">Move ‚Üí</button>
                <button class="item-control-btn" onclick="moveItem(0, -0.2)">‚Üë Move</button>
                <button class="item-control-btn" onclick="moveItem(0, 0.2)">Move ‚Üì</button>
                <button class="item-control-btn" onclick="rotateItem(15)">‚Üª Rotate</button>
                <button class="item-control-btn" onclick="rotateItem(-15)">‚Ü∫ Rotate</button>
                <button class="item-control-btn danger" onclick="deleteItem()">üóëÔ∏è Delete</button>
            </div>
        </div>

        <div class="decorator-category" id="cat-seating">
            <h3 onclick="toggleCategory('cat-seating')">Seating</h3>
            <div class="item-grid">
                <div class="item-card" onclick="selectFurniture('cushion-orange')">
                    <div class="item-preview" style="background: linear-gradient(135deg, #fd7e14 0%, #e06b0a 100%); border-radius: 50%;">üü†</div>
                    <div class="item-name">Orange Cushion</div>
                </div>
                <div class="item-card" onclick="selectFurniture('cushion-teal')">
                    <div class="item-preview" style="background: linear-gradient(135deg, #20c997 0%, #17a085 100%); border-radius: 50%;">ü©µ</div>
                    <div class="item-name">Teal Cushion</div>
                </div>
                <div class="item-card" onclick="selectFurniture('cushion-pink')">
                    <div class="item-preview" style="background: linear-gradient(135deg, #d63384 0%, #b52a70 100%); border-radius: 50%;">ü©∑</div>
                    <div class="item-name">Pink Cushion</div>
                </div>
                <div class="item-card" onclick="selectFurniture('cushion-yellow')">
                    <div class="item-preview" style="background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); border-radius: 50%;">üü°</div>
                    <div class="item-name">Yellow Cushion</div>
                </div>
                <div class="item-card" onclick="selectFurniture('cushion-gray')">
                    <div class="item-preview" style="background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%); border-radius: 50%;">‚ö™</div>
                    <div class="item-name">Gray Cushion</div>
                </div>
                <div class="item-card" onclick="selectFurniture('cushion-red')">
                    <div class="item-preview" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); border-radius: 50%;">üî¥</div>
                    <div class="item-name">Red Cushion</div>
                </div>
                <div class="item-card" onclick="selectFurniture('beanbag-orange')">
                    <div class="item-preview" style="background: linear-gradient(145deg, #fd7e14 0%, #c96000 100%); border-radius: 30%;">üß°</div>
                    <div class="item-name">Bean Bag</div>
                </div>
                <div class="item-card" onclick="selectFurniture('mattress-ochre')">
                    <div class="item-preview" style="background: linear-gradient(135deg, #c9a227 0%, #a88520 100%); border-radius: 8px;">üü®</div>
                    <div class="item-name">Tufted Mattress</div>
                </div>
                <div class="item-card" onclick="selectFurniture('sofa-gray')">
                    <div class="item-preview" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%); border-radius: 4px;">üõãÔ∏è</div>
                    <div class="item-name">Gray Sofa</div>
                </div>
            </div>
        </div>

        <div class="decorator-category" id="cat-tables">
            <h3 onclick="toggleCategory('cat-tables')">Tables</h3>
            <div class="item-grid">
                <div class="item-card" onclick="selectFurniture('table-display')">
                    <div class="item-preview" style="background: linear-gradient(135deg, #d4a76a 0%, #c4956a 100%); border-radius: 4px;">ü™µ</div>
                    <div class="item-name">Display Table</div>
                </div>
                <div class="item-card" onclick="selectFurniture('table-coffee')">
                    <div class="item-preview" style="background: linear-gradient(135deg, #c4a77d 0%, #b09567 100%); border-radius: 50%;">‚òï</div>
                    <div class="item-name">Coffee Table</div>
                </div>
                <div class="item-card" onclick="selectFurniture('table-side')">
                    <div class="item-preview" style="background: linear-gradient(135deg, #ffd93d 0%, #e0c030 100%); border-radius: 50%;">üü°</div>
                    <div class="item-name">Side Table</div>
                </div>
                <div class="item-card" onclick="selectFurniture('bench-wood')">
                    <div class="item-preview" style="background: linear-gradient(135deg, #d4a76a 0%, #b8906a 100%); border-radius: 2px;">ü™ë</div>
                    <div class="item-name">Wood Bench</div>
                </div>
            </div>
        </div>

        <div class="decorator-category" id="cat-storage">
            <h3 onclick="toggleCategory('cat-storage')">Storage & Display</h3>
            <div class="item-grid">
                <div class="item-card" onclick="selectFurniture('shelf-wood')">
                    <div class="item-preview" style="background: linear-gradient(135deg, #e8d4b8 0%, #d4c0a8 100%);">üìö</div>
                    <div class="item-name">Bookshelf</div>
                </div>
                <div class="item-card" onclick="selectFurniture('display-red')">
                    <div class="item-preview" style="background: linear-gradient(135deg, #c41e3a 0%, #a01830 100%);">üìï</div>
                    <div class="item-name">Red Display</div>
                </div>
                <div class="item-card" onclick="selectFurniture('screen-folding')">
                    <div class="item-preview" style="background: linear-gradient(135deg, #d4a76a 0%, #c4956a 100%);">üö™</div>
                    <div class="item-name">Folding Screen</div>
                </div>
                <div class="item-card" onclick="selectFurniture('rack-wire')">
                    <div class="item-preview" style="background: linear-gradient(135deg, #888 0%, #666 100%);">üóÑÔ∏è</div>
                    <div class="item-name">Wire Rack</div>
                </div>
            </div>
        </div>

        <div class="decorator-category" id="cat-rugs">
            <h3 onclick="toggleCategory('cat-rugs')">Rugs & Textiles</h3>
            <div class="item-grid">
                <div class="item-card" onclick="selectFurniture('rug-persian-burgundy')">
                    <div class="item-preview" style="background: linear-gradient(135deg, #8b2942 0%, #6a1f32 100%); border-radius: 2px;">üü•</div>
                    <div class="item-name">Burgundy Rug</div>
                </div>
                <div class="item-card" onclick="selectFurniture('rug-persian-teal')">
                    <div class="item-preview" style="background: linear-gradient(135deg, #2d5a5a 0%, #1f4040 100%); border-radius: 2px;">üü©</div>
                    <div class="item-name">Teal Rug</div>
                </div>
                <div class="item-card" onclick="selectFurniture('rug-striped')">
                    <div class="item-preview" style="background: repeating-linear-gradient(90deg, #c9a227 0px, #c9a227 10px, #8b6914 10px, #8b6914 20px); border-radius: 2px;">üü®</div>
                    <div class="item-name">Striped Rug</div>
                </div>
                <div class="item-card" onclick="selectFurniture('tablecloth-yellow')">
                    <div class="item-preview" style="background: linear-gradient(135deg, #ffd93d 0%, #e0c030 100%); border-radius: 2px;">üü°</div>
                    <div class="item-name">Yellow Cloth</div>
                </div>
            </div>
        </div>

        <div class="decorator-category" id="cat-lighting">
            <h3 onclick="toggleCategory('cat-lighting')">Lighting</h3>
            <div class="item-grid">
                <div class="item-card" onclick="selectFurniture('light-pendant')">
                    <div class="item-preview" style="background: linear-gradient(180deg, #333 0%, #d4a76a 100%); border-radius: 0 0 50% 50%;">üí°</div>
                    <div class="item-name">Pendant Light</div>
                </div>
                <div class="item-card" onclick="selectFurniture('light-floor')">
                    <div class="item-preview" style="background: linear-gradient(135deg, #f5f5f5 0%, #ccc 100%);">ü™î</div>
                    <div class="item-name">Floor Lamp</div>
                </div>
                <div class="item-card" onclick="selectFurniture('disco-ball')">
                    <div class="item-preview" style="background: linear-gradient(135deg, #c0c0c0 0%, #808080 50%, #c0c0c0 100%); border-radius: 50%;">ü™©</div>
                    <div class="item-name">Disco Ball</div>
                </div>
            </div>
        </div>

        <div class="decorator-category" id="cat-plants">
            <h3 onclick="toggleCategory('cat-plants')">Plants & Decor</h3>
            <div class="item-grid">
                <div class="item-card" onclick="selectFurniture('plant-large')">
                    <div class="item-preview" style="background: linear-gradient(180deg, #228b22 0%, #c4713d 70%);">ü™¥</div>
                    <div class="item-name">Large Plant</div>
                </div>
                <div class="item-card" onclick="selectFurniture('plant-small')">
                    <div class="item-preview" style="background: linear-gradient(180deg, #32cd32 0%, #8b4513 80%);">üå±</div>
                    <div class="item-name">Small Plant</div>
                </div>
                <div class="item-card" onclick="selectFurniture('vase-flowers')">
                    <div class="item-preview" style="background: linear-gradient(180deg, #ff69b4 0%, #4169e1 70%);">üíê</div>
                    <div class="item-name">Vase</div>
                </div>
            </div>
        </div>

        <div class="decorator-category" id="cat-wallart">
            <h3 onclick="toggleCategory('cat-wallart')">Wall Art - Afrikadaa</h3>
            <div class="item-grid">
                <div class="item-card art-item-card" onclick="selectFurniture('poster-afrikadaa-1')">
                    <div class="item-preview" style="background: linear-gradient(135deg, #ff6b6b 0%, #ffd93d 50%, #4ecdc4 100%);">üñºÔ∏è</div>
                    <div class="item-name">Afrikadaa Cover #1</div>
                </div>
                <div class="item-card art-item-card" onclick="selectFurniture('poster-afrikadaa-2')">
                    <div class="item-preview" style="background: linear-gradient(135deg, #45b7d1 0%, #96ceb4 100%);">üñºÔ∏è</div>
                    <div class="item-name">Afrikadaa Cover #2</div>
                </div>
                <div class="item-card art-item-card" onclick="selectFurniture('poster-afrikadaa-3')">
                    <div class="item-preview" style="background: linear-gradient(135deg, #e17055 0%, #fdcb6e 100%);">üñºÔ∏è</div>
                    <div class="item-name">African Contemporary</div>
                </div>
            </div>
        </div>

        <div class="decorator-category" id="cat-wallart2">
            <h3 onclick="toggleCategory('cat-wallart2')">Wall Art - Coolhunt Paris</h3>
            <div class="item-grid">
                <div class="item-card art-item-card" onclick="selectFurniture('poster-coolhunt-1')">
                    <div class="item-preview" style="background: linear-gradient(135deg, #1a1a1a 0%, #4a4a4a 100%);">üì∑</div>
                    <div class="item-name">Fashion Photo</div>
                </div>
                <div class="item-card art-item-card" onclick="selectFurniture('poster-coolhunt-2')">
                    <div class="item-preview" style="background: linear-gradient(135deg, #ff6b6b 0%, #c41e3a 100%);">üé®</div>
                    <div class="item-name">Street Art Print</div>
                </div>
                <div class="item-card art-item-card" onclick="selectFurniture('poster-coolhunt-3')">
                    <div class="item-preview" style="background: linear-gradient(135deg, #74b9ff 0%, #a29bfe 100%);">üñåÔ∏è</div>
                    <div class="item-name">Design Print</div>
                </div>
            </div>
        </div>

        <div class="decorator-category" id="cat-activist">
            <h3 onclick="toggleCategory('cat-activist')">Wall Art - Activist</h3>
            <div class="item-grid">
                <div class="item-card art-item-card" onclick="selectFurniture('poster-activist-1')">
                    <div class="item-preview" style="background: #1a3a5c; color: #fff; font-size: 10px; padding: 5px;">WE WANT TO LIVE FREE</div>
                    <div class="item-name">Live Free Banner</div>
                </div>
                <div class="item-card art-item-card" onclick="selectFurniture('poster-activist-2')">
                    <div class="item-preview" style="background: #f5f0e8; color: #1a1a1a; font-size: 10px; padding: 5px;">SOMOS PERSONAS</div>
                    <div class="item-name">Somos Personas</div>
                </div>
                <div class="item-card art-item-card" onclick="selectFurniture('poster-activist-3')">
                    <div class="item-preview" style="background: linear-gradient(135deg, #c41e3a 0%, #1a1a1a 100%); font-size: 10px;">‚úä</div>
                    <div class="item-name">Resistance Art</div>
                </div>
            </div>
        </div>

        <div class="decorator-actions">
            <button class="decorator-action-btn primary" onclick="saveLayout()">üíæ Save Layout</button>
            <button class="decorator-action-btn secondary" onclick="loadLayout()">üìÇ Load Layout</button>
            <button class="decorator-action-btn secondary" onclick="resetLayout()">üîÑ Reset</button>
            <button class="decorator-action-btn secondary" onclick="exportLayout()">üì§ Export JSON</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Scene setup
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1a1a1a);

        const container = document.getElementById('canvas-container');
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);

        const renderer = new THREE.WebGLRenderer({ antialias: true, preserveDrawingBuffer: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        container.appendChild(renderer.domElement);

        // ============================================================
        // EXACT DIMENSIONS FROM FLOOR PLAN (converted to meters)
        // CORRECTED LAYOUT: Windows on FRONT (south), Doors on BACK (north)
        // Room 5202 "Special Special" is LEFT, Room 5203 "Reading Room" is RIGHT
        // Room 5202 has an entry vestibule/corridor before main space
        // ============================================================
        const ROOM_5202_WIDTH = 3.496;  // 11'-5‚Öù" (X direction)
        const ROOM_5202_DEPTH = 7.715;  // 25'-3¬æ" (Z direction)
        const ROOM_5203_WIDTH = 4.465;  // 14'-7¬æ"
        const ROOM_5203_DEPTH = 7.715;  // 25'-3¬æ"
        const CEILING_HEIGHT = 3.66;   // 12' ceiling
        const WALL_THICKNESS = 0.152;  // 6"
        const DOOR_WIDTH = 1.044;      // 3'-5‚Öõ"
        const DOOR_HEIGHT = 2.134;     // 7'-0"

        // Entry vestibule dimensions for Room 5202 (estimated from plan)
        const VESTIBULE_WIDTH = ROOM_5202_WIDTH;  // Same width as room
        const VESTIBULE_DEPTH = 1.5;  // ~5' deep vestibule/corridor

        // Window dimensions (from reference photos - MoMA PS1 industrial windows)
        // Tall rectangular windows with white frames, grid pattern
        const PS1_WINDOW_WIDTH = 1.3;      // ~4.25 feet
        const PS1_WINDOW_HEIGHT = 2.2;     // ~7.25 feet tall
        const PS1_WINDOW_SILL = 0.75;      // ~2.5 feet sill height
        const PS1_COLUMN_WIDTH = 0.25;     // White fluted columns between windows

        // Materials
        const wallMaterial = new THREE.MeshLambertMaterial({ color: 0xf8f8f5, side: THREE.DoubleSide });
        const brickMaterial = new THREE.MeshLambertMaterial({ color: 0xf0ebe5, side: THREE.DoubleSide });
        const floorMaterial = new THREE.MeshLambertMaterial({ color: 0xd4c8b8 });
        const darkBlueMaterial = new THREE.MeshLambertMaterial({ color: 0x2c3e5c });
        const windowFrameMaterial = new THREE.MeshLambertMaterial({ color: 0xe8e8e8 });
        const glassMaterial = new THREE.MeshLambertMaterial({ color: 0x87CEEB, transparent: true, opacity: 0.25 });
        const woodMaterial = new THREE.MeshLambertMaterial({ color: 0xd4a76a });
        const ochreFloorMaterial = new THREE.MeshLambertMaterial({ color: 0xc9a227 });
        const redMaterial = new THREE.MeshLambertMaterial({ color: 0xc41e3a });

        // Groups for visibility control
        const labelsGroup = new THREE.Group();
        const ceilingsGroup = new THREE.Group();
        const wallsGroup = new THREE.Group();
        const room5202Walls = { front: null, back: null, left: null, right: null, vestibuleLeft: null, vestibuleRight: null };
        const room5203Walls = { front: null, back: null, left: null, right: null };

        const gridHelper = new THREE.GridHelper(20, 40, 0x444444, 0x333333);
        scene.add(gridHelper);

        // Position rooms side by side (Room 5202 LEFT, Room 5203 RIGHT)
        const TOTAL_WIDTH = ROOM_5202_WIDTH + WALL_THICKNESS + ROOM_5203_WIDTH;
        const ROOM_5202_X = -TOTAL_WIDTH / 2 + ROOM_5202_WIDTH / 2;
        const ROOM_5203_X = TOTAL_WIDTH / 2 - ROOM_5203_WIDTH / 2;

        // ============ HELPER FUNCTIONS ============

        function createArchedWindow(width, height, archRadius, hasFabricFrame = true) {
            const group = new THREE.Group();
            const frameThickness = 0.08;

            // Glass
            const glassShape = new THREE.Shape();
            glassShape.moveTo(-width/2, 0);
            glassShape.lineTo(-width/2, height - archRadius);
            glassShape.quadraticCurveTo(-width/2, height, 0, height);
            glassShape.quadraticCurveTo(width/2, height, width/2, height - archRadius);
            glassShape.lineTo(width/2, 0);
            glassShape.lineTo(-width/2, 0);

            const glass = new THREE.Mesh(new THREE.ShapeGeometry(glassShape), glassMaterial);
            group.add(glass);

            // Frame bars
            const leftFrame = new THREE.Mesh(new THREE.BoxGeometry(frameThickness, height - archRadius, frameThickness), windowFrameMaterial);
            leftFrame.position.set(-width/2, (height - archRadius)/2, 0);
            group.add(leftFrame);

            const rightFrame = new THREE.Mesh(new THREE.BoxGeometry(frameThickness, height - archRadius, frameThickness), windowFrameMaterial);
            rightFrame.position.set(width/2, (height - archRadius)/2, 0);
            group.add(rightFrame);

            const bottomFrame = new THREE.Mesh(new THREE.BoxGeometry(width + frameThickness, frameThickness, frameThickness), windowFrameMaterial);
            bottomFrame.position.set(0, 0, 0);
            group.add(bottomFrame);

            const centerFrame = new THREE.Mesh(new THREE.BoxGeometry(frameThickness, height - archRadius, frameThickness), windowFrameMaterial);
            centerFrame.position.set(0, (height - archRadius)/2, 0);
            group.add(centerFrame);

            const middleFrame = new THREE.Mesh(new THREE.BoxGeometry(width, frameThickness, frameThickness), windowFrameMaterial);
            middleFrame.position.set(0, height * 0.4, 0);
            group.add(middleFrame);

            // Dark blue fabric frame
            if (hasFabricFrame) {
                const fabricWidth = width + 0.4;
                const fabricHeight = height + 0.3;
                const leftFabric = new THREE.Mesh(new THREE.BoxGeometry(0.15, fabricHeight, 0.02), darkBlueMaterial);
                leftFabric.position.set(-fabricWidth/2, fabricHeight/2, 0.02);
                group.add(leftFabric);
                const rightFabric = new THREE.Mesh(new THREE.BoxGeometry(0.15, fabricHeight, 0.02), darkBlueMaterial);
                rightFabric.position.set(fabricWidth/2, fabricHeight/2, 0.02);
                group.add(rightFabric);
                const topFabric = new THREE.Mesh(new THREE.BoxGeometry(fabricWidth, 0.15, 0.02), darkBlueMaterial);
                topFabric.position.set(0, fabricHeight - 0.1, 0.02);
                group.add(topFabric);
            }

            return group;
        }

        // MoMA PS1 style industrial window - tall rectangular with grid pattern
        function createPS1Window(width, height) {
            const group = new THREE.Group();

            // Glass pane
            const glass = new THREE.Mesh(
                new THREE.PlaneGeometry(width, height),
                glassMaterial
            );
            group.add(glass);

            // White window frame
            const frameThickness = 0.05;
            const frameMat = new THREE.MeshLambertMaterial({ color: 0xffffff });

            // Outer frame
            const topFrame = new THREE.Mesh(new THREE.BoxGeometry(width + 0.08, frameThickness, frameThickness), frameMat);
            topFrame.position.set(0, height/2, 0.02);
            group.add(topFrame);

            const bottomFrame = new THREE.Mesh(new THREE.BoxGeometry(width + 0.08, frameThickness, frameThickness), frameMat);
            bottomFrame.position.set(0, -height/2, 0.02);
            group.add(bottomFrame);

            const leftFrame = new THREE.Mesh(new THREE.BoxGeometry(frameThickness, height, frameThickness), frameMat);
            leftFrame.position.set(-width/2, 0, 0.02);
            group.add(leftFrame);

            const rightFrame = new THREE.Mesh(new THREE.BoxGeometry(frameThickness, height, frameThickness), frameMat);
            rightFrame.position.set(width/2, 0, 0.02);
            group.add(rightFrame);

            // Horizontal dividers (3 panes vertically = 2 dividers)
            const dividerH1 = new THREE.Mesh(new THREE.BoxGeometry(width, frameThickness * 0.7, frameThickness), frameMat);
            dividerH1.position.set(0, height * 0.2, 0.02);
            group.add(dividerH1);

            const dividerH2 = new THREE.Mesh(new THREE.BoxGeometry(width, frameThickness * 0.7, frameThickness), frameMat);
            dividerH2.position.set(0, -height * 0.2, 0.02);
            group.add(dividerH2);

            // Vertical center divider
            const centerV = new THREE.Mesh(new THREE.BoxGeometry(frameThickness * 0.7, height, frameThickness), frameMat);
            centerV.position.set(0, 0, 0.02);
            group.add(centerV);

            return group;
        }

        // Create white fluted column/pilaster (decorative element between windows)
        function createFlutedColumn(height) {
            const group = new THREE.Group();
            const columnMat = new THREE.MeshLambertMaterial({ color: 0xf5f5f0 });

            // Main column body
            const column = new THREE.Mesh(
                new THREE.BoxGeometry(PS1_COLUMN_WIDTH, height, 0.1),
                columnMat
            );
            column.position.set(0, height/2, 0);
            group.add(column);

            // Add fluting detail (vertical ridges)
            const fluteMat = new THREE.MeshLambertMaterial({ color: 0xe8e8e3 });
            for (let i = -2; i <= 2; i++) {
                const flute = new THREE.Mesh(
                    new THREE.BoxGeometry(0.02, height, 0.03),
                    fluteMat
                );
                flute.position.set(i * 0.05, height/2, 0.06);
                group.add(flute);
            }

            return group;
        }

        function createFloorCushion(color, size = 0.6) {
            const group = new THREE.Group();
            const cushion = new THREE.Mesh(new THREE.SphereGeometry(size / 2, 16, 12), new THREE.MeshLambertMaterial({ color }));
            cushion.scale.set(1, 0.5, 1);
            cushion.position.set(0, size * 0.25, 0);
            group.add(cushion);
            return group;
        }

        function createTuftedFloorMattress(width, depth) {
            const group = new THREE.Group();
            const mattress = new THREE.Mesh(new THREE.BoxGeometry(width, 0.2, depth), ochreFloorMaterial);
            mattress.position.set(0, 0.1, 0);
            group.add(mattress);
            const buttonMat = new THREE.MeshLambertMaterial({ color: 0xa88520 });
            for (let x = -width/2 + 0.3; x < width/2; x += 0.3) {
                for (let z = -depth/2 + 0.3; z < depth/2; z += 0.3) {
                    const button = new THREE.Mesh(new THREE.CylinderGeometry(0.02, 0.02, 0.05, 8), buttonMat);
                    button.position.set(x, 0.2, z);
                    group.add(button);
                }
            }
            return group;
        }

        function createLayeredRug(width, depth, color) {
            const group = new THREE.Group();
            const rug = new THREE.Mesh(new THREE.BoxGeometry(width, 0.02, depth), new THREE.MeshLambertMaterial({ color }));
            rug.position.set(0, 0.01, 0);
            group.add(rug);
            const borderMat = new THREE.MeshLambertMaterial({ color: 0x2d2d2d });
            const topBorder = new THREE.Mesh(new THREE.BoxGeometry(width, 0.025, 0.05), borderMat);
            topBorder.position.set(0, 0.02, -depth/2 + 0.025);
            group.add(topBorder);
            const bottomBorder = new THREE.Mesh(new THREE.BoxGeometry(width, 0.025, 0.05), borderMat);
            bottomBorder.position.set(0, 0.02, depth/2 - 0.025);
            group.add(bottomBorder);
            return group;
        }

        function createWoodenBookshelf(width, height, rows) {
            const group = new THREE.Group();
            const shelfWood = new THREE.MeshLambertMaterial({ color: 0xe8d4b8 });
            const backPanel = new THREE.Mesh(new THREE.BoxGeometry(width, height, 0.02), shelfWood);
            backPanel.position.set(0, height/2, 0);
            group.add(backPanel);

            const shelfSpacing = height / (rows + 1);
            for (let i = 1; i <= rows; i++) {
                const shelf = new THREE.Mesh(new THREE.BoxGeometry(width, 0.02, 0.15), shelfWood);
                shelf.position.set(0, i * shelfSpacing, 0.08);
                group.add(shelf);
                const bookCount = Math.floor(width / 0.2);
                const bookColors = [0x4ecdc4, 0xff6b6b, 0xffd93d, 0x45b7d1, 0x96ceb4, 0xa29bfe, 0xe17055, 0x00b894];
                for (let j = 0; j < bookCount; j++) {
                    const book = new THREE.Mesh(new THREE.BoxGeometry(0.15, 0.2, 0.02), new THREE.MeshLambertMaterial({ color: bookColors[j % bookColors.length] }));
                    book.position.set(-width/2 + 0.1 + j * 0.18, i * shelfSpacing + 0.12, 0.14);
                    group.add(book);
                }
            }
            return group;
        }

        function createPottedPlant() {
            const group = new THREE.Group();
            const pot = new THREE.Mesh(new THREE.CylinderGeometry(0.12, 0.1, 0.2, 12), new THREE.MeshLambertMaterial({ color: 0xc4713d }));
            pot.position.set(0, 0.1, 0);
            group.add(pot);
            const soil = new THREE.Mesh(new THREE.CylinderGeometry(0.11, 0.11, 0.03, 12), new THREE.MeshLambertMaterial({ color: 0x4a3728 }));
            soil.position.set(0, 0.2, 0);
            group.add(soil);
            const leafMat = new THREE.MeshLambertMaterial({ color: 0x228b22 });
            for (let i = 0; i < 6; i++) {
                const leaf = new THREE.Mesh(new THREE.SphereGeometry(0.08 + Math.random() * 0.04, 8, 8), leafMat);
                leaf.position.set((Math.random() - 0.5) * 0.15, 0.35 + Math.random() * 0.15, (Math.random() - 0.5) * 0.15);
                leaf.scale.set(1, 0.6, 1);
                group.add(leaf);
            }
            return group;
        }

        function createPendantLight() {
            const group = new THREE.Group();
            const cord = new THREE.Mesh(new THREE.CylinderGeometry(0.01, 0.01, 0.8, 8), new THREE.MeshLambertMaterial({ color: 0x333333 }));
            cord.position.set(0, 0.4, 0);
            group.add(cord);
            const shade = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.25, 0.2, 16, 1, true), new THREE.MeshLambertMaterial({ color: 0xd4a76a, side: THREE.DoubleSide }));
            group.add(shade);
            const bulb = new THREE.Mesh(new THREE.SphereGeometry(0.05, 8, 8), new THREE.MeshBasicMaterial({ color: 0xfffacd }));
            group.add(bulb);
            return group;
        }

        function createLowCoffeeTable() {
            const group = new THREE.Group();
            const tableMat = new THREE.MeshLambertMaterial({ color: 0xc4a77d });
            const top = new THREE.Mesh(new THREE.CylinderGeometry(0.4, 0.4, 0.04, 24), tableMat);
            top.position.set(0, 0.25, 0);
            group.add(top);
            for (let i = 0; i < 3; i++) {
                const angle = (i * 2 * Math.PI) / 3;
                const leg = new THREE.Mesh(new THREE.CylinderGeometry(0.03, 0.04, 0.23, 8), tableMat);
                leg.position.set(Math.cos(angle) * 0.25, 0.115, Math.sin(angle) * 0.25);
                group.add(leg);
            }
            return group;
        }

        function createRedBookDisplay() {
            const group = new THREE.Group();
            const bodyWidth = 0.7, bodyHeight = 0.9, bodyDepth = 0.5;
            const backPanel = new THREE.Mesh(new THREE.BoxGeometry(bodyWidth, bodyHeight, 0.03), redMaterial);
            backPanel.position.set(0, bodyHeight/2, -bodyDepth/2);
            group.add(backPanel);
            for (let i = 0; i < 4; i++) {
                const shelf = new THREE.Mesh(new THREE.BoxGeometry(bodyWidth - 0.05, 0.02, bodyDepth * 0.6), redMaterial);
                shelf.position.set(0, 0.15 + i * 0.2, -0.1);
                shelf.rotation.x = -0.2;
                group.add(shelf);
                const bookColors = [0xffffff, 0x4ecdc4, 0xff6b6b, 0xffd93d, 0x95e1d3];
                for (let j = 0; j < 5; j++) {
                    const book = new THREE.Mesh(new THREE.BoxGeometry(0.08, 0.15, 0.01), new THREE.MeshLambertMaterial({ color: bookColors[j] }));
                    book.position.set(-0.25 + j * 0.12, 0.25 + i * 0.2, 0);
                    book.rotation.x = -0.3;
                    group.add(book);
                }
            }
            const sideL = new THREE.Mesh(new THREE.BoxGeometry(0.03, bodyHeight, bodyDepth), redMaterial);
            sideL.position.set(-bodyWidth/2, bodyHeight/2, 0);
            group.add(sideL);
            const sideR = new THREE.Mesh(new THREE.BoxGeometry(0.03, bodyHeight, bodyDepth), redMaterial);
            sideR.position.set(bodyWidth/2, bodyHeight/2, 0);
            group.add(sideR);
            return group;
        }

        function createPosterWall(width, height) {
            const group = new THREE.Group();
            const baseWall = new THREE.Mesh(new THREE.PlaneGeometry(width, height), new THREE.MeshLambertMaterial({ color: 0xf5f0e8 }));
            group.add(baseWall);
            const posterColors = [0xff6b6b, 0xffd93d, 0x4ecdc4, 0x45b7d1, 0x96ceb4, 0xffeaa7, 0xdfe6e9, 0xfd79a8, 0x00b894, 0xe17055, 0x74b9ff, 0xa29bfe, 0x55efc4, 0xfdcb6e, 0xe84393];
            for (let i = 0; i < 60; i++) {
                const posterW = 0.15 + Math.random() * 0.3;
                const posterH = 0.2 + Math.random() * 0.35;
                const poster = new THREE.Mesh(new THREE.PlaneGeometry(posterW, posterH), new THREE.MeshLambertMaterial({ color: posterColors[Math.floor(Math.random() * posterColors.length)] }));
                poster.position.set((Math.random() - 0.5) * (width - posterW), (Math.random() - 0.5) * (height - posterH), 0.005 + i * 0.001);
                poster.rotation.z = (Math.random() - 0.5) * 0.1;
                group.add(poster);
            }
            return group;
        }

        // ============ ROOM 5202 - SPECIAL SPECIAL ============
        // LAYOUT: Windows on FRONT (+Z), Door to corridor on BACK (-Z) via VESTIBULE, Door to 5203 on RIGHT (+X)
        // Has an entry vestibule/corridor - a narrow enclosed passage before the main room
        function createRoom5202() {
            const group = new THREE.Group();

            // Vestibule corridor dimensions - enclosed passage with side walls
            const CORRIDOR_WIDTH = 1.2;  // Narrow corridor width (~4 feet)
            const CORRIDOR_OFFSET_X = 0;  // Corridor centered on door

            // ========== FLOOR (entire room) ==========
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(ROOM_5202_WIDTH, ROOM_5202_DEPTH), floorMaterial);
            floor.rotation.x = -Math.PI / 2;
            floor.position.set(0, 0.01, 0);
            group.add(floor);

            // Dark blue carpet in main area (not in vestibule)
            const carpet = new THREE.Mesh(new THREE.PlaneGeometry(ROOM_5202_WIDTH - 0.5, ROOM_5202_DEPTH - VESTIBULE_DEPTH - 0.5), new THREE.MeshLambertMaterial({ color: 0x1a3a5c }));
            carpet.rotation.x = -Math.PI / 2;
            carpet.position.set(0, 0.02, VESTIBULE_DEPTH / 2);
            group.add(carpet);

            // ========== BACK WALL (-Z) - Door to corridor/STUDIO ==========
            const backWallGroup = new THREE.Group();
            const backWall1 = new THREE.Mesh(new THREE.BoxGeometry((ROOM_5202_WIDTH - DOOR_WIDTH) / 2, CEILING_HEIGHT, WALL_THICKNESS), wallMaterial);
            backWall1.position.set(-ROOM_5202_WIDTH / 4 - DOOR_WIDTH / 4, CEILING_HEIGHT / 2, -ROOM_5202_DEPTH / 2);
            backWallGroup.add(backWall1);
            const backWall2 = new THREE.Mesh(new THREE.BoxGeometry((ROOM_5202_WIDTH - DOOR_WIDTH) / 2, CEILING_HEIGHT, WALL_THICKNESS), wallMaterial);
            backWall2.position.set(ROOM_5202_WIDTH / 4 + DOOR_WIDTH / 4, CEILING_HEIGHT / 2, -ROOM_5202_DEPTH / 2);
            backWallGroup.add(backWall2);
            const backDoorHeader = new THREE.Mesh(new THREE.BoxGeometry(DOOR_WIDTH, CEILING_HEIGHT - DOOR_HEIGHT, WALL_THICKNESS), wallMaterial);
            backDoorHeader.position.set(0, DOOR_HEIGHT + (CEILING_HEIGHT - DOOR_HEIGHT) / 2, -ROOM_5202_DEPTH / 2);
            backWallGroup.add(backDoorHeader);
            group.add(backWallGroup);
            room5202Walls.back = backWallGroup;

            // ========== VESTIBULE CORRIDOR WALLS ==========
            // The vestibule is an enclosed corridor with:
            // - Two SIDE walls running from back wall (-Z) toward the room (+Z)
            // - One FRONT wall (partition) with a door opening to main room
            const vestibuleGroup = new THREE.Group();

            // LEFT side wall of vestibule (runs along Z axis)
            const vestibuleLeftSide = new THREE.Mesh(
                new THREE.BoxGeometry(WALL_THICKNESS, CEILING_HEIGHT, VESTIBULE_DEPTH),
                wallMaterial
            );
            vestibuleLeftSide.position.set(
                CORRIDOR_OFFSET_X - CORRIDOR_WIDTH / 2,
                CEILING_HEIGHT / 2,
                -ROOM_5202_DEPTH / 2 + VESTIBULE_DEPTH / 2
            );
            vestibuleGroup.add(vestibuleLeftSide);

            // RIGHT side wall of vestibule (runs along Z axis)
            const vestibuleRightSide = new THREE.Mesh(
                new THREE.BoxGeometry(WALL_THICKNESS, CEILING_HEIGHT, VESTIBULE_DEPTH),
                wallMaterial
            );
            vestibuleRightSide.position.set(
                CORRIDOR_OFFSET_X + CORRIDOR_WIDTH / 2,
                CEILING_HEIGHT / 2,
                -ROOM_5202_DEPTH / 2 + VESTIBULE_DEPTH / 2
            );
            vestibuleGroup.add(vestibuleRightSide);

            // FRONT partition wall of vestibule (with door opening to main room)
            // Left section of front partition
            const partitionLeftWidth = (ROOM_5202_WIDTH / 2) - (CORRIDOR_WIDTH / 2) - CORRIDOR_OFFSET_X;
            if (partitionLeftWidth > 0) {
                const partitionLeft = new THREE.Mesh(
                    new THREE.BoxGeometry(partitionLeftWidth, CEILING_HEIGHT, WALL_THICKNESS),
                    wallMaterial
                );
                partitionLeft.position.set(
                    -ROOM_5202_WIDTH / 2 + partitionLeftWidth / 2,
                    CEILING_HEIGHT / 2,
                    -ROOM_5202_DEPTH / 2 + VESTIBULE_DEPTH
                );
                vestibuleGroup.add(partitionLeft);
            }

            // Right section of front partition
            const partitionRightWidth = (ROOM_5202_WIDTH / 2) - (CORRIDOR_WIDTH / 2) + CORRIDOR_OFFSET_X;
            if (partitionRightWidth > 0) {
                const partitionRight = new THREE.Mesh(
                    new THREE.BoxGeometry(partitionRightWidth, CEILING_HEIGHT, WALL_THICKNESS),
                    wallMaterial
                );
                partitionRight.position.set(
                    ROOM_5202_WIDTH / 2 - partitionRightWidth / 2,
                    CEILING_HEIGHT / 2,
                    -ROOM_5202_DEPTH / 2 + VESTIBULE_DEPTH
                );
                vestibuleGroup.add(partitionRight);
            }

            // Header above vestibule door opening
            const vestibuleDoorHeader = new THREE.Mesh(
                new THREE.BoxGeometry(CORRIDOR_WIDTH, CEILING_HEIGHT - DOOR_HEIGHT, WALL_THICKNESS),
                wallMaterial
            );
            vestibuleDoorHeader.position.set(
                CORRIDOR_OFFSET_X,
                DOOR_HEIGHT + (CEILING_HEIGHT - DOOR_HEIGHT) / 2,
                -ROOM_5202_DEPTH / 2 + VESTIBULE_DEPTH
            );
            vestibuleGroup.add(vestibuleDoorHeader);

            group.add(vestibuleGroup);
            room5202Walls.vestibuleLeft = vestibuleLeftSide;
            room5202Walls.vestibuleRight = vestibuleRightSide;
            room5202Walls.vestibuleGroup = vestibuleGroup;  // Store entire vestibule for hiding

            // ========== FRONT WALL (+Z) - PS1 Industrial Windows ==========
            const frontWallGroup = new THREE.Group();

            // Wall below windows (sill area)
            const frontWallBase = new THREE.Mesh(
                new THREE.BoxGeometry(ROOM_5202_WIDTH, PS1_WINDOW_SILL, WALL_THICKNESS),
                wallMaterial
            );
            frontWallBase.position.set(0, PS1_WINDOW_SILL / 2, ROOM_5202_DEPTH / 2);
            frontWallGroup.add(frontWallBase);

            // Wall above windows
            const topWallHeight = CEILING_HEIGHT - PS1_WINDOW_SILL - PS1_WINDOW_HEIGHT;
            const frontWallTop = new THREE.Mesh(
                new THREE.BoxGeometry(ROOM_5202_WIDTH, topWallHeight, WALL_THICKNESS),
                wallMaterial
            );
            frontWallTop.position.set(0, PS1_WINDOW_SILL + PS1_WINDOW_HEIGHT + topWallHeight / 2, ROOM_5202_DEPTH / 2);
            frontWallGroup.add(frontWallTop);

            // Two windows with fluted column between them
            const windowSpacing = (ROOM_5202_WIDTH - PS1_COLUMN_WIDTH) / 2;
            const windowCenterY = PS1_WINDOW_SILL + PS1_WINDOW_HEIGHT / 2;

            // Left window
            const win1 = createPS1Window(PS1_WINDOW_WIDTH, PS1_WINDOW_HEIGHT);
            win1.position.set(-windowSpacing / 2, windowCenterY, ROOM_5202_DEPTH / 2 - 0.02);
            frontWallGroup.add(win1);

            // Right window
            const win2 = createPS1Window(PS1_WINDOW_WIDTH, PS1_WINDOW_HEIGHT);
            win2.position.set(windowSpacing / 2, windowCenterY, ROOM_5202_DEPTH / 2 - 0.02);
            frontWallGroup.add(win2);

            // Fluted column between windows
            const column5202 = createFlutedColumn(PS1_WINDOW_HEIGHT);
            column5202.position.set(0, PS1_WINDOW_SILL, ROOM_5202_DEPTH / 2 - 0.02);
            frontWallGroup.add(column5202);

            // Wall sections on either side of windows
            const sideWallWidth = (ROOM_5202_WIDTH - windowSpacing * 2 - PS1_WINDOW_WIDTH * 2) / 2 + 0.3;
            if (sideWallWidth > 0.1) {
                const leftSide = new THREE.Mesh(
                    new THREE.BoxGeometry(sideWallWidth, PS1_WINDOW_HEIGHT, WALL_THICKNESS),
                    wallMaterial
                );
                leftSide.position.set(-ROOM_5202_WIDTH / 2 + sideWallWidth / 2, windowCenterY, ROOM_5202_DEPTH / 2);
                frontWallGroup.add(leftSide);

                const rightSide = new THREE.Mesh(
                    new THREE.BoxGeometry(sideWallWidth, PS1_WINDOW_HEIGHT, WALL_THICKNESS),
                    wallMaterial
                );
                rightSide.position.set(ROOM_5202_WIDTH / 2 - sideWallWidth / 2, windowCenterY, ROOM_5202_DEPTH / 2);
                frontWallGroup.add(rightSide);
            }

            group.add(frontWallGroup);
            room5202Walls.front = frontWallGroup;

            // ========== LEFT WALL (-X) - Wall with CLOSED DOOR to Three Star room ==========
            const leftWallGroup = new THREE.Group();
            // Door to Three Star room - positioned toward the back of the room
            const threeStarDoorZ = -ROOM_5202_DEPTH / 4;  // Door position along Z axis

            // Wall segment in front of door (toward windows)
            const leftWallFront = new THREE.Mesh(
                new THREE.BoxGeometry(WALL_THICKNESS, CEILING_HEIGHT, ROOM_5202_DEPTH / 2 - DOOR_WIDTH / 2 - threeStarDoorZ),
                wallMaterial
            );
            leftWallFront.position.set(-ROOM_5202_WIDTH / 2, CEILING_HEIGHT / 2, ROOM_5202_DEPTH / 4 + (ROOM_5202_DEPTH / 2 - DOOR_WIDTH / 2 - threeStarDoorZ) / 2 - DOOR_WIDTH / 4);
            leftWallGroup.add(leftWallFront);

            // Wall segment behind door (toward corridor)
            const leftWallBack = new THREE.Mesh(
                new THREE.BoxGeometry(WALL_THICKNESS, CEILING_HEIGHT, ROOM_5202_DEPTH / 2 + threeStarDoorZ - DOOR_WIDTH / 2),
                wallMaterial
            );
            leftWallBack.position.set(-ROOM_5202_WIDTH / 2, CEILING_HEIGHT / 2, -ROOM_5202_DEPTH / 4 + threeStarDoorZ / 2 - DOOR_WIDTH / 4);
            leftWallGroup.add(leftWallBack);

            // Door header above the Three Star door
            const leftDoorHeader = new THREE.Mesh(
                new THREE.BoxGeometry(WALL_THICKNESS, CEILING_HEIGHT - DOOR_HEIGHT, DOOR_WIDTH),
                wallMaterial
            );
            leftDoorHeader.position.set(-ROOM_5202_WIDTH / 2, DOOR_HEIGHT + (CEILING_HEIGHT - DOOR_HEIGHT) / 2, threeStarDoorZ);
            leftWallGroup.add(leftDoorHeader);

            // CLOSED DOOR to Three Star room (actual door panel)
            const threeStarDoor = new THREE.Mesh(
                new THREE.BoxGeometry(0.05, DOOR_HEIGHT, DOOR_WIDTH),
                new THREE.MeshLambertMaterial({ color: 0x8B4513 })  // Wood brown color
            );
            threeStarDoor.position.set(-ROOM_5202_WIDTH / 2 + 0.03, DOOR_HEIGHT / 2, threeStarDoorZ);
            leftWallGroup.add(threeStarDoor);

            // Door handle
            const doorHandle = new THREE.Mesh(
                new THREE.BoxGeometry(0.03, 0.12, 0.03),
                new THREE.MeshLambertMaterial({ color: 0xC0C0C0 })  // Silver
            );
            doorHandle.position.set(-ROOM_5202_WIDTH / 2 + 0.07, DOOR_HEIGHT / 2, threeStarDoorZ + DOOR_WIDTH / 2 - 0.1);
            leftWallGroup.add(doorHandle);

            group.add(leftWallGroup);
            room5202Walls.left = leftWallGroup;

            // ========== RIGHT WALL (+X) - OPEN PASSAGE to Room 5203 (NO DOOR) ==========
            // This is an open archway/passage between the two rooms - no wall here except header
            const rightWallGroup = new THREE.Group();

            // Only a header above the open passage (if ceiling is higher than passage)
            // The passage is full height so no header needed, but we add small wall sections at front and back
            const passageWidth = 2.0;  // Wide open passage between rooms
            const passageZ = 0;  // Centered

            // Small wall section at the BACK (near vestibule area)
            const rightWallBack = new THREE.Mesh(
                new THREE.BoxGeometry(WALL_THICKNESS, CEILING_HEIGHT, ROOM_5202_DEPTH / 2 - passageWidth / 2),
                wallMaterial
            );
            rightWallBack.position.set(ROOM_5202_WIDTH / 2, CEILING_HEIGHT / 2, -ROOM_5202_DEPTH / 4 - passageWidth / 4);
            rightWallGroup.add(rightWallBack);

            // Small wall section at the FRONT (near windows)
            const rightWallFront = new THREE.Mesh(
                new THREE.BoxGeometry(WALL_THICKNESS, CEILING_HEIGHT, ROOM_5202_DEPTH / 2 - passageWidth / 2),
                wallMaterial
            );
            rightWallFront.position.set(ROOM_5202_WIDTH / 2, CEILING_HEIGHT / 2, ROOM_5202_DEPTH / 4 + passageWidth / 4);
            rightWallGroup.add(rightWallFront);

            group.add(rightWallGroup);
            room5202Walls.right = rightWallGroup;

            // ========== CEILING ==========
            const ceiling = new THREE.Mesh(new THREE.PlaneGeometry(ROOM_5202_WIDTH, ROOM_5202_DEPTH), wallMaterial);
            ceiling.rotation.x = Math.PI / 2;
            ceiling.position.set(0, CEILING_HEIGHT, 0);
            ceiling.userData.isCeiling = true;
            ceilingsGroup.add(ceiling);
            group.add(ceilingsGroup);

            // ========== FURNITURE ==========
            // Display table with colorful cloth (in main room area, past the vestibule)
            const mainRoomZ = VESTIBULE_DEPTH / 2 + 0.5;
            const tableCloth = new THREE.Mesh(new THREE.BoxGeometry(2.1, 0.02, 0.9), new THREE.MeshLambertMaterial({ color: 0xffd93d }));
            tableCloth.position.set(0, 0.74, mainRoomZ);
            group.add(tableCloth);
            const displayTable = new THREE.Mesh(new THREE.BoxGeometry(2, 0.72, 0.8), woodMaterial);
            displayTable.position.set(0, 0.36, mainRoomZ);
            group.add(displayTable);

            // Books on table
            const bookColors = [0x4ecdc4, 0xff6b6b, 0xffd93d, 0x45b7d1, 0x96ceb4, 0xdfe6e9, 0x74b9ff, 0xe17055];
            for (let i = 0; i < 10; i++) {
                const book = new THREE.Mesh(new THREE.BoxGeometry(0.12 + Math.random() * 0.08, 0.015, 0.16 + Math.random() * 0.06), new THREE.MeshLambertMaterial({ color: bookColors[i % bookColors.length] }));
                book.position.set(-0.7 + (i % 5) * 0.3 + (Math.random() - 0.5) * 0.1, 0.76 + Math.floor(i / 5) * 0.02, mainRoomZ + (Math.random() - 0.5) * 0.3);
                book.rotation.y = Math.random() * 0.5 - 0.25;
                group.add(book);
            }

            // Floor cushions (near window wall for listening)
            const cushion1 = createFloorCushion(0xfd7e14, 0.6);
            cushion1.position.set(-0.8, 0.03, ROOM_5202_DEPTH / 3);
            group.add(cushion1);
            const cushion2 = createFloorCushion(0x20c997, 0.55);
            cushion2.position.set(0.3, 0.03, ROOM_5202_DEPTH / 3 + 0.3);
            group.add(cushion2);
            const cushion3 = createFloorCushion(0xd63384, 0.5);
            cushion3.position.set(-0.2, 0.03, ROOM_5202_DEPTH / 3 - 0.3);
            group.add(cushion3);

            // Bookshelf against left wall in main room area (past the vestibule)
            const smallShelf = createWoodenBookshelf(1.2, 1.6, 3);
            smallShelf.position.set(-ROOM_5202_WIDTH / 2 + 0.2, 0, 0.5);
            smallShelf.rotation.y = Math.PI / 2;
            group.add(smallShelf);

            // Potted plant
            const plant = createPottedPlant();
            plant.position.set(ROOM_5202_WIDTH / 2 - 0.4, 0, ROOM_5202_DEPTH / 3);
            group.add(plant);

            // Pendant light (in main room)
            const pendant = createPendantLight();
            pendant.position.set(0, CEILING_HEIGHT - 0.8, mainRoomZ);
            group.add(pendant);

            return group;
        }

        // ============ ROOM 5203 - READING ROOM ============
        // LAYOUT: Windows on FRONT (+Z), Door to corridor on BACK (-Z), Door to 5202 on LEFT (-X)
        function createRoom5203() {
            const group = new THREE.Group();

            // Floor
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(ROOM_5203_WIDTH, ROOM_5203_DEPTH), floorMaterial);
            floor.rotation.x = -Math.PI / 2;
            floor.position.set(0, 0.01, 0);
            group.add(floor);

            // BACK WALL (-Z) - Door to corridor (door is positioned toward LEFT, not centered)
            // From floor plan: door is closer to the shared wall with 5202
            const backWallGroup = new THREE.Group();
            const doorOffsetX = -ROOM_5203_WIDTH / 4;  // Door offset toward left (shared wall side)

            // Left wall section (small, between door and left wall)
            const leftWallWidth = ROOM_5203_WIDTH / 2 + doorOffsetX - DOOR_WIDTH / 2;
            if (leftWallWidth > 0.1) {
                const backWallLeft = new THREE.Mesh(
                    new THREE.BoxGeometry(leftWallWidth, CEILING_HEIGHT, WALL_THICKNESS),
                    brickMaterial
                );
                backWallLeft.position.set(-ROOM_5203_WIDTH / 2 + leftWallWidth / 2, CEILING_HEIGHT / 2, -ROOM_5203_DEPTH / 2);
                backWallGroup.add(backWallLeft);
            }

            // Right wall section (larger, most of the poster wall)
            const rightWallWidth = ROOM_5203_WIDTH / 2 - doorOffsetX - DOOR_WIDTH / 2;
            const backWallRight = new THREE.Mesh(
                new THREE.BoxGeometry(rightWallWidth, CEILING_HEIGHT, WALL_THICKNESS),
                brickMaterial
            );
            backWallRight.position.set(ROOM_5203_WIDTH / 2 - rightWallWidth / 2, CEILING_HEIGHT / 2, -ROOM_5203_DEPTH / 2);
            backWallGroup.add(backWallRight);

            // Door header
            const backDoorHeader = new THREE.Mesh(
                new THREE.BoxGeometry(DOOR_WIDTH, CEILING_HEIGHT - DOOR_HEIGHT, WALL_THICKNESS),
                brickMaterial
            );
            backDoorHeader.position.set(doorOffsetX, DOOR_HEIGHT + (CEILING_HEIGHT - DOOR_HEIGHT) / 2, -ROOM_5203_DEPTH / 2);
            backWallGroup.add(backDoorHeader);

            // Poster wall on right section (main poster wall area)
            const posterWall = createPosterWall(rightWallWidth - 0.2, CEILING_HEIGHT - 0.3);
            posterWall.position.set(ROOM_5203_WIDTH / 2 - rightWallWidth / 2, CEILING_HEIGHT / 2, -ROOM_5203_DEPTH / 2 + WALL_THICKNESS / 2 + 0.02);
            backWallGroup.add(posterWall);

            group.add(backWallGroup);
            room5203Walls.back = backWallGroup;

            // FRONT WALL (+Z) - PS1 Industrial Windows (same style as 5202)
            const frontWallGroup = new THREE.Group();

            // Wall below windows
            const frontWallBase = new THREE.Mesh(
                new THREE.BoxGeometry(ROOM_5203_WIDTH, PS1_WINDOW_SILL, WALL_THICKNESS),
                brickMaterial
            );
            frontWallBase.position.set(0, PS1_WINDOW_SILL / 2, ROOM_5203_DEPTH / 2);
            frontWallGroup.add(frontWallBase);

            // Wall above windows
            const topWallHeight5203 = CEILING_HEIGHT - PS1_WINDOW_SILL - PS1_WINDOW_HEIGHT;
            const frontWallTop = new THREE.Mesh(
                new THREE.BoxGeometry(ROOM_5203_WIDTH, topWallHeight5203, WALL_THICKNESS),
                brickMaterial
            );
            frontWallTop.position.set(0, PS1_WINDOW_SILL + PS1_WINDOW_HEIGHT + topWallHeight5203 / 2, ROOM_5203_DEPTH / 2);
            frontWallGroup.add(frontWallTop);

            // Room 5203 is wider, so it can have 3 windows with 2 columns
            const windowCenterY5203 = PS1_WINDOW_SILL + PS1_WINDOW_HEIGHT / 2;
            const totalWindowArea = ROOM_5203_WIDTH - 0.4;  // Leave some wall on sides
            const numWindows = 3;
            const numColumns = 2;
            const windowWidth5203 = (totalWindowArea - numColumns * PS1_COLUMN_WIDTH) / numWindows;
            const windowSpacing5203 = windowWidth5203 + PS1_COLUMN_WIDTH;

            // Create 3 windows with columns between
            for (let i = 0; i < numWindows; i++) {
                const xPos = -totalWindowArea / 2 + windowWidth5203 / 2 + i * windowSpacing5203;
                const win = createPS1Window(windowWidth5203 * 0.9, PS1_WINDOW_HEIGHT);
                win.position.set(xPos, windowCenterY5203, ROOM_5203_DEPTH / 2 - 0.02);
                frontWallGroup.add(win);

                // Add column after each window except the last
                if (i < numWindows - 1) {
                    const col = createFlutedColumn(PS1_WINDOW_HEIGHT);
                    col.position.set(xPos + windowSpacing5203 / 2, PS1_WINDOW_SILL, ROOM_5203_DEPTH / 2 - 0.02);
                    frontWallGroup.add(col);
                }
            }

            // Side wall sections
            const sideWidth5203 = 0.2;
            const leftSide5203 = new THREE.Mesh(
                new THREE.BoxGeometry(sideWidth5203, PS1_WINDOW_HEIGHT, WALL_THICKNESS),
                brickMaterial
            );
            leftSide5203.position.set(-ROOM_5203_WIDTH / 2 + sideWidth5203 / 2, windowCenterY5203, ROOM_5203_DEPTH / 2);
            frontWallGroup.add(leftSide5203);

            const rightSide5203 = new THREE.Mesh(
                new THREE.BoxGeometry(sideWidth5203, PS1_WINDOW_HEIGHT, WALL_THICKNESS),
                brickMaterial
            );
            rightSide5203.position.set(ROOM_5203_WIDTH / 2 - sideWidth5203 / 2, windowCenterY5203, ROOM_5203_DEPTH / 2);
            frontWallGroup.add(rightSide5203);

            group.add(frontWallGroup);
            room5203Walls.front = frontWallGroup;

            // LEFT WALL (-X) - OPEN PASSAGE to Room 5202 (NO DOOR - open archway)
            const leftWallGroup = new THREE.Group();
            const passageWidth5203 = 2.0;  // Same wide open passage

            // Small wall section at the BACK (near corridor door)
            const leftWall1 = new THREE.Mesh(
                new THREE.BoxGeometry(WALL_THICKNESS, CEILING_HEIGHT, ROOM_5203_DEPTH / 2 - passageWidth5203 / 2),
                brickMaterial
            );
            leftWall1.position.set(-ROOM_5203_WIDTH / 2, CEILING_HEIGHT / 2, -ROOM_5203_DEPTH / 4 - passageWidth5203 / 4);
            leftWallGroup.add(leftWall1);

            // Small wall section at the FRONT (near windows)
            const leftWall2 = new THREE.Mesh(
                new THREE.BoxGeometry(WALL_THICKNESS, CEILING_HEIGHT, ROOM_5203_DEPTH / 2 - passageWidth5203 / 2),
                brickMaterial
            );
            leftWall2.position.set(-ROOM_5203_WIDTH / 2, CEILING_HEIGHT / 2, ROOM_5203_DEPTH / 4 + passageWidth5203 / 4);
            leftWallGroup.add(leftWall2);

            // No door header - it's a full-height open passage
            group.add(leftWallGroup);
            room5203Walls.left = leftWallGroup;

            // RIGHT WALL (+X) - Solid exterior wall
            const rightWall = new THREE.Mesh(new THREE.BoxGeometry(WALL_THICKNESS, CEILING_HEIGHT, ROOM_5203_DEPTH), brickMaterial);
            rightWall.position.set(ROOM_5203_WIDTH / 2, CEILING_HEIGHT / 2, 0);
            group.add(rightWall);
            room5203Walls.right = rightWall;

            // Ceiling
            const ceiling = new THREE.Mesh(new THREE.PlaneGeometry(ROOM_5203_WIDTH, ROOM_5203_DEPTH), wallMaterial);
            ceiling.rotation.x = Math.PI / 2;
            ceiling.position.set(0, CEILING_HEIGHT, 0);
            ceiling.userData.isCeiling = true;
            ceilingsGroup.add(ceiling);
            group.add(ceilingsGroup);

            // FURNITURE - Reading area

            // Layered rugs
            const mainRug = createLayeredRug(3.5, 2.5, 0x8b2942);
            mainRug.position.set(0, 0, 0);
            group.add(mainRug);
            const rug2 = createLayeredRug(2.2, 1.8, 0x2d5a5a);
            rug2.position.set(-0.6, 0.02, -0.3);
            rug2.rotation.y = -0.15;
            group.add(rug2);

            // Tufted floor mattress
            const floorMattress = createTuftedFloorMattress(2.2, 1.4);
            floorMattress.position.set(0, 0.05, 0);
            group.add(floorMattress);

            // Floor cushions around mattress
            const cushionColors = [0xd63384, 0xdc3545, 0x20c997, 0xfd7e14, 0xffc107, 0x6c757d];
            const cushionPositions = [[-0.8, 0.5], [0.7, 0.3], [-0.4, 1.2], [0.9, 1.0], [-1.1, 0.8], [1.1, 0.5]];
            cushionPositions.forEach((pos, i) => {
                const cushion = createFloorCushion(cushionColors[i], 0.5 + Math.random() * 0.2);
                cushion.position.set(pos[0], 0.15, pos[1]);
                group.add(cushion);
            });

            // Low coffee table
            const coffeeTable = createLowCoffeeTable();
            coffeeTable.position.set(0, 0.15, 0.8);
            group.add(coffeeTable);

            // Book displays near back wall
            const bookDisplay1 = createRedBookDisplay();
            bookDisplay1.position.set(-1.2, 0, -ROOM_5203_DEPTH / 2 + 1);
            group.add(bookDisplay1);
            const bookDisplay2 = createRedBookDisplay();
            bookDisplay2.position.set(1.2, 0, -ROOM_5203_DEPTH / 2 + 1);
            group.add(bookDisplay2);

            // Bookshelf near side wall
            const bookshelf = createWoodenBookshelf(2, 2.2, 4);
            bookshelf.position.set(ROOM_5203_WIDTH / 2 - 0.3, 0, -1);
            bookshelf.rotation.y = -Math.PI / 2;
            group.add(bookshelf);

            // Plants
            const plant1 = createPottedPlant();
            plant1.position.set(ROOM_5203_WIDTH / 2 - 0.4, 0, ROOM_5203_DEPTH / 3);
            group.add(plant1);
            const plant2 = createPottedPlant();
            plant2.position.set(-ROOM_5203_WIDTH / 2 + 0.4, 0, ROOM_5203_DEPTH / 3);
            group.add(plant2);

            // Pendant lights
            const pendant1 = createPendantLight();
            pendant1.position.set(-1, CEILING_HEIGHT - 0.8, 0);
            group.add(pendant1);
            const pendant2 = createPendantLight();
            pendant2.position.set(1, CEILING_HEIGHT - 0.8, 0.5);
            group.add(pendant2);

            return group;
        }

        // Create and position rooms
        const room5202 = createRoom5202();
        room5202.position.set(ROOM_5202_X, 0, 0);
        scene.add(room5202);

        const room5203 = createRoom5203();
        room5203.position.set(ROOM_5203_X, 0, 0);
        scene.add(room5203);

        // Room labels
        function createLabel(text, position) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 512;
            canvas.height = 128;
            ctx.fillStyle = 'rgba(0,0,0,0.8)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'white';
            ctx.font = 'bold 32px Helvetica';
            ctx.textAlign = 'center';
            ctx.fillText(text, canvas.width / 2, canvas.height / 2 + 10);
            const texture = new THREE.CanvasTexture(canvas);
            const material = new THREE.SpriteMaterial({ map: texture });
            const sprite = new THREE.Sprite(material);
            sprite.scale.set(2.5, 0.6, 1);
            sprite.position.copy(position);
            return sprite;
        }

        labelsGroup.add(createLabel('ROOM 5202 - SPECIAL SPECIAL', new THREE.Vector3(ROOM_5202_X, CEILING_HEIGHT + 0.5, 0)));
        labelsGroup.add(createLabel('ROOM 5203 - READING ROOM', new THREE.Vector3(ROOM_5203_X, CEILING_HEIGHT + 0.5, 0)));
        scene.add(labelsGroup);

        // Lighting
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.7);
        directionalLight.position.set(10, 15, 10);
        directionalLight.castShadow = true;
        scene.add(directionalLight);
        const fillLight = new THREE.DirectionalLight(0xffffff, 0.3);
        fillLight.position.set(-10, 10, -10);
        scene.add(fillLight);
        const room5202Light = new THREE.PointLight(0xffffee, 0.4, 12);
        room5202Light.position.set(ROOM_5202_X, CEILING_HEIGHT - 0.5, 0);
        scene.add(room5202Light);
        const room5203Light = new THREE.PointLight(0xffffee, 0.4, 12);
        room5203Light.position.set(ROOM_5203_X, CEILING_HEIGHT - 0.5, 0);
        scene.add(room5203Light);

        // Camera controls
        let isMouseDown = false;
        let mouseX = 0, mouseY = 0;
        let targetRotationX = 0, targetRotationY = 0.4;
        let currentRotationX = 0, currentRotationY = 0.4;
        let cameraDistance = 18;
        let cameraTarget = new THREE.Vector3(0, 2, 0);

        camera.position.set(0, 12, 18);
        camera.lookAt(cameraTarget);

        container.addEventListener('mousedown', (e) => { isMouseDown = true; mouseX = e.clientX; mouseY = e.clientY; });
        container.addEventListener('mouseup', () => isMouseDown = false);
        container.addEventListener('mouseleave', () => isMouseDown = false);

        container.addEventListener('mousemove', (e) => {
            if (!isMouseDown) return;
            targetRotationX += (e.clientX - mouseX) * 0.005;
            targetRotationY += (e.clientY - mouseY) * 0.005;
            targetRotationY = Math.max(-0.5, Math.min(1.2, targetRotationY));
            mouseX = e.clientX; mouseY = e.clientY;
        });

        container.addEventListener('wheel', (e) => {
            cameraDistance += e.deltaY * 0.01;
            cameraDistance = Math.max(3, Math.min(35, cameraDistance));
        });

        const keys = {};
        document.addEventListener('keydown', (e) => keys[e.key.toLowerCase()] = true);
        document.addEventListener('keyup', (e) => keys[e.key.toLowerCase()] = false);

        // Touch controls
        container.addEventListener('touchstart', (e) => { isMouseDown = true; mouseX = e.touches[0].clientX; mouseY = e.touches[0].clientY; });
        container.addEventListener('touchend', () => isMouseDown = false);
        container.addEventListener('touchmove', (e) => {
            if (!isMouseDown) return;
            targetRotationX += (e.touches[0].clientX - mouseX) * 0.005;
            targetRotationY += (e.touches[0].clientY - mouseY) * 0.005;
            targetRotationY = Math.max(-0.5, Math.min(1.2, targetRotationY));
            mouseX = e.touches[0].clientX; mouseY = e.touches[0].clientY;
        });

        // View presets - CORRECTED FOR DOOR ENTRY PERSPECTIVE
        // Entry views: Camera at BACK (door, -Z) looking FORWARD toward windows (+Z)
        // rotX=0 means camera is at front looking back, rotX=Math.PI means camera at back looking forward
        const views = {
            overview: { rotX: 0, rotY: 0.5, dist: 18, target: new THREE.Vector3(0, 2, 0) },
            floorPlan: { rotX: 0, rotY: 1.5, dist: 14, target: new THREE.Vector3(0, 0, 0) },
            // Room 5202 views - Entry through vestibule door, looking toward windows
            // rotX=Math.PI puts camera at -Z (door) looking toward +Z (windows)
            room5202Entry: { rotX: Math.PI, rotY: 0.15, dist: 3, target: new THREE.Vector3(ROOM_5202_X, 1.5, -ROOM_5202_DEPTH / 2 + 1) },
            room5202Inside: { rotX: Math.PI, rotY: 0.2, dist: 5, target: new THREE.Vector3(ROOM_5202_X, 1.5, 0) },
            room5202Windows: { rotX: Math.PI, rotY: 0.15, dist: 4, target: new THREE.Vector3(ROOM_5202_X, 1.5, ROOM_5202_DEPTH / 4) },
            room5202Table: { rotX: Math.PI * 0.8, rotY: 0.25, dist: 4, target: new THREE.Vector3(ROOM_5202_X, 0.8, 0) },
            // Room 5203 views - Entry through corridor door, looking toward arched windows
            room5203Entry: { rotX: Math.PI, rotY: 0.15, dist: 3, target: new THREE.Vector3(ROOM_5203_X, 1.5, -ROOM_5203_DEPTH / 2 + 1) },
            room5203Inside: { rotX: Math.PI, rotY: 0.2, dist: 6, target: new THREE.Vector3(ROOM_5203_X, 1.5, 0) },
            room5203Windows: { rotX: Math.PI, rotY: 0.15, dist: 4, target: new THREE.Vector3(ROOM_5203_X, 1.5, ROOM_5203_DEPTH / 4) },
            room5203Seating: { rotX: Math.PI * 0.7, rotY: 0.2, dist: 4, target: new THREE.Vector3(ROOM_5203_X, 0.5, 0.5) },
            room5203Shelves: { rotX: Math.PI * 1.2, rotY: 0.2, dist: 5, target: new THREE.Vector3(ROOM_5203_X, 1.2, -ROOM_5203_DEPTH / 3) }
        };

        function animateToView(view, duration = 1500) {
            const startRotX = currentRotationX, startRotY = currentRotationY;
            const startDist = cameraDistance;
            const startTarget = cameraTarget.clone();
            const startTime = Date.now();

            function update() {
                const elapsed = Date.now() - startTime;
                const t = Math.min(elapsed / duration, 1);
                const eased = t < 0.5 ? 2 * t * t : 1 - Math.pow(-2 * t + 2, 2) / 2;

                targetRotationX = startRotX + (view.rotX - startRotX) * eased;
                targetRotationY = startRotY + (view.rotY - startRotY) * eased;
                cameraDistance = startDist + (view.dist - startDist) * eased;
                cameraTarget.lerpVectors(startTarget, view.target, eased);

                if (t < 1) requestAnimationFrame(update);
            }
            update();
        }

        window.setView = function(viewName) { const view = views[viewName]; if (view) animateToView(view); };
        window.focusRoom = function(room) {
            if (room === 'room5202') setView('room5202Inside');
            else if (room === 'room5203') setView('room5203Inside');
        };

        let tourRunning = false;
        window.startTour = function() {
            if (tourRunning) return;
            tourRunning = true;
            // Tour starts from entry doors, walking through each room
            const stops = ['overview', 'room5202Entry', 'room5202Inside', 'room5202Windows', 'room5202Table', 'room5203Entry', 'room5203Inside', 'room5203Windows', 'room5203Seating', 'room5203Shelves', 'overview'];
            let i = 0;
            function next() {
                if (i >= stops.length) { tourRunning = false; return; }
                animateToView(views[stops[i++]], 2000);
                setTimeout(next, 3500);
            }
            next();
        };

        // Toggle functions
        let showGrid = true, showLabels = true, showCeiling = true, hideNearWall = false, showWireframe = false;

        window.toggleGrid = function() {
            showGrid = !showGrid;
            gridHelper.visible = showGrid;
            document.getElementById('gridBtn').classList.toggle('active', showGrid);
        };

        window.toggleLabels = function() {
            showLabels = !showLabels;
            labelsGroup.visible = showLabels;
            document.getElementById('labelsBtn').classList.toggle('active', showLabels);
        };

        window.toggleCeiling = function() {
            showCeiling = !showCeiling;
            ceilingsGroup.traverse((obj) => {
                if (obj.userData.isCeiling || obj.isMesh) obj.visible = showCeiling;
            });
            document.getElementById('ceilingBtn').classList.toggle('active', showCeiling);
        };

        window.toggleNearWall = function() {
            hideNearWall = !hideNearWall;
            document.getElementById('nearWallBtn').classList.toggle('active', hideNearWall);
        };

        window.toggleWireframe = function() {
            showWireframe = !showWireframe;
            document.getElementById('wireframeBtn').classList.toggle('active', showWireframe);
            scene.traverse((obj) => { if (obj.isMesh && obj.material) obj.material.wireframe = showWireframe; });
        };

        window.captureScreenshot = function() {
            const link = document.createElement('a');
            link.download = 'PanafricanLibrary_ReadingRoom.png';
            link.href = renderer.domElement.toDataURL('image/png');
            link.click();
        };

        window.toggleMoodboard = function() {
            const modal = document.getElementById('moodboard-modal');
            modal.classList.toggle('modal-hidden');
        };

        // ============ DECORATOR MODE ============
        let decoratorMode = false;
        let selectedFurnitureType = null;
        let selectedPlacedItem = null;
        let placedItems = [];
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        window.toggleDecorator = function() {
            const panel = document.getElementById('decorator-panel');
            panel.classList.toggle('open');
            decoratorMode = panel.classList.contains('open');
            if (!decoratorMode) {
                deselectAll();
            }
        };

        window.toggleCategory = function(catId) {
            document.getElementById(catId).classList.toggle('collapsed');
        };

        window.selectFurniture = function(type) {
            // Deselect previous
            document.querySelectorAll('.item-card').forEach(c => c.classList.remove('selected'));
            // Select new
            event.currentTarget.classList.add('selected');
            selectedFurnitureType = type;
            selectedPlacedItem = null;
            updateSelectedInfo();
        };

        function deselectAll() {
            document.querySelectorAll('.item-card').forEach(c => c.classList.remove('selected'));
            selectedFurnitureType = null;
            selectedPlacedItem = null;
            updateSelectedInfo();
        }

        function updateSelectedInfo() {
            const info = document.getElementById('selected-item-info');
            const nameSpan = document.getElementById('selected-name');
            if (selectedPlacedItem) {
                info.classList.add('visible');
                nameSpan.textContent = selectedPlacedItem.userData.itemType || 'Item';
            } else if (selectedFurnitureType) {
                info.classList.add('visible');
                nameSpan.textContent = selectedFurnitureType + ' (click to place)';
            } else {
                info.classList.remove('visible');
            }
        }

        // Create furniture based on type
        function createFurnitureItem(type) {
            let item;
            switch(type) {
                // Cushions
                case 'cushion-orange': item = createFloorCushion(0xfd7e14, 0.6); break;
                case 'cushion-teal': item = createFloorCushion(0x20c997, 0.6); break;
                case 'cushion-pink': item = createFloorCushion(0xd63384, 0.6); break;
                case 'cushion-yellow': item = createFloorCushion(0xffc107, 0.6); break;
                case 'cushion-gray': item = createFloorCushion(0x6c757d, 0.6); break;
                case 'cushion-red': item = createFloorCushion(0xdc3545, 0.6); break;
                // Bean bag
                case 'beanbag-orange': item = createBeanbag(0xfd7e14); break;
                // Mattress
                case 'mattress-ochre': item = createTuftedFloorMattress(2.2, 1.4); break;
                // Sofa
                case 'sofa-gray': item = createLowSofa(); break;
                // Tables
                case 'table-display': item = createDisplayTable(); break;
                case 'table-coffee': item = createLowCoffeeTable(); break;
                case 'table-side': item = createSideTable(); break;
                case 'bench-wood': item = createWoodenBench(); break;
                // Storage
                case 'shelf-wood': item = createWoodenBookshelf(1.2, 1.6, 3); break;
                case 'display-red': item = createRedBookDisplay(); break;
                case 'screen-folding': item = createFoldingScreen(); break;
                case 'rack-wire': item = createWireRack(); break;
                // Rugs
                case 'rug-persian-burgundy': item = createLayeredRug(3.5, 2.5, 0x8b2942); break;
                case 'rug-persian-teal': item = createLayeredRug(2.2, 1.8, 0x2d5a5a); break;
                case 'rug-striped': item = createStripedRug(); break;
                case 'tablecloth-yellow': item = createTablecloth(0xffd93d); break;
                // Lighting
                case 'light-pendant': item = createPendantLight(); break;
                case 'light-floor': item = createFloorLamp(); break;
                case 'disco-ball': item = createDiscoBall(); break;
                // Plants
                case 'plant-large': item = createPottedPlant(); break;
                case 'plant-small': item = createSmallPlant(); break;
                case 'vase-flowers': item = createVase(); break;
                // Wall art - these need special placement
                case 'poster-afrikadaa-1': item = createWallPoster(0xff6b6b, 0.6, 0.8, 'Afrikadaa #1'); break;
                case 'poster-afrikadaa-2': item = createWallPoster(0x45b7d1, 0.5, 0.7, 'Afrikadaa #2'); break;
                case 'poster-afrikadaa-3': item = createWallPoster(0xe17055, 0.5, 0.65, 'African Art'); break;
                case 'poster-coolhunt-1': item = createWallPoster(0x1a1a1a, 0.5, 0.7, 'Fashion'); break;
                case 'poster-coolhunt-2': item = createWallPoster(0xc41e3a, 0.6, 0.8, 'Street Art'); break;
                case 'poster-coolhunt-3': item = createWallPoster(0x74b9ff, 0.4, 0.5, 'Design'); break;
                case 'poster-activist-1': item = createTextBanner('WE WANT TO LIVE FREE', 0x1a3a5c); break;
                case 'poster-activist-2': item = createTextBanner('SOMOS PERSONAS', 0xf5f0e8, 0x1a1a1a); break;
                case 'poster-activist-3': item = createWallPoster(0xc41e3a, 0.7, 0.9, 'Resistance'); break;
                default: item = createFloorCushion(0x888888, 0.5);
            }
            item.userData.itemType = type;
            item.userData.isPlacedItem = true;
            return item;
        }

        // Additional furniture creation functions
        function createBeanbag(color) {
            const group = new THREE.Group();
            const bean = new THREE.Mesh(
                new THREE.SphereGeometry(0.45, 16, 16),
                new THREE.MeshLambertMaterial({ color })
            );
            bean.scale.set(1.2, 0.7, 1);
            bean.position.set(0, 0.3, 0);
            group.add(bean);
            return group;
        }

        function createLowSofa() {
            const group = new THREE.Group();
            const mat = new THREE.MeshLambertMaterial({ color: 0x6c757d });
            const seat = new THREE.Mesh(new THREE.BoxGeometry(1.8, 0.3, 0.8), mat);
            seat.position.set(0, 0.25, 0);
            group.add(seat);
            const back = new THREE.Mesh(new THREE.BoxGeometry(1.8, 0.4, 0.15), mat);
            back.position.set(0, 0.5, -0.35);
            group.add(back);
            const armL = new THREE.Mesh(new THREE.BoxGeometry(0.15, 0.35, 0.8), mat);
            armL.position.set(-0.85, 0.35, 0);
            group.add(armL);
            const armR = new THREE.Mesh(new THREE.BoxGeometry(0.15, 0.35, 0.8), mat);
            armR.position.set(0.85, 0.35, 0);
            group.add(armR);
            return group;
        }

        function createDisplayTable() {
            const group = new THREE.Group();
            const tableMat = new THREE.MeshLambertMaterial({ color: 0xd4a76a });
            const top = new THREE.Mesh(new THREE.BoxGeometry(2, 0.04, 0.8), tableMat);
            top.position.set(0, 0.72, 0);
            group.add(top);
            const legs = [[0.9, 0.3], [0.9, -0.3], [-0.9, 0.3], [-0.9, -0.3]];
            legs.forEach(([x, z]) => {
                const leg = new THREE.Mesh(new THREE.BoxGeometry(0.05, 0.7, 0.05), tableMat);
                leg.position.set(x, 0.35, z);
                group.add(leg);
            });
            return group;
        }

        function createSideTable() {
            const group = new THREE.Group();
            const mat = new THREE.MeshLambertMaterial({ color: 0xffd93d });
            const top = new THREE.Mesh(new THREE.CylinderGeometry(0.25, 0.25, 0.03, 16), mat);
            top.position.set(0, 0.45, 0);
            group.add(top);
            const leg = new THREE.Mesh(new THREE.CylinderGeometry(0.03, 0.04, 0.43, 8), mat);
            leg.position.set(0, 0.22, 0);
            group.add(leg);
            return group;
        }

        function createWoodenBench() {
            const group = new THREE.Group();
            const mat = new THREE.MeshLambertMaterial({ color: 0xd4a76a });
            const seat = new THREE.Mesh(new THREE.BoxGeometry(1.5, 0.05, 0.4), mat);
            seat.position.set(0, 0.45, 0);
            group.add(seat);
            const legs = [[0.65, 0.1], [0.65, -0.1], [-0.65, 0.1], [-0.65, -0.1]];
            legs.forEach(([x, z]) => {
                const leg = new THREE.Mesh(new THREE.BoxGeometry(0.05, 0.43, 0.05), mat);
                leg.position.set(x, 0.22, z);
                group.add(leg);
            });
            return group;
        }

        function createFoldingScreen() {
            const group = new THREE.Group();
            const mat = new THREE.MeshLambertMaterial({ color: 0xd4a76a, side: THREE.DoubleSide });
            for (let i = -1; i <= 1; i++) {
                const panel = new THREE.Mesh(new THREE.BoxGeometry(0.6, 1.8, 0.02), mat);
                panel.position.set(i * 0.5, 0.9, i * 0.1);
                panel.rotation.y = i * 0.3;
                group.add(panel);
            }
            return group;
        }

        function createWireRack() {
            const group = new THREE.Group();
            const mat = new THREE.MeshLambertMaterial({ color: 0x888888 });
            for (let y = 0; y < 4; y++) {
                const shelf = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.02, 0.3), mat);
                shelf.position.set(0, 0.3 + y * 0.3, 0);
                group.add(shelf);
            }
            const legs = [[0.18, 0.13], [0.18, -0.13], [-0.18, 0.13], [-0.18, -0.13]];
            legs.forEach(([x, z]) => {
                const leg = new THREE.Mesh(new THREE.CylinderGeometry(0.01, 0.01, 1.2, 8), mat);
                leg.position.set(x, 0.6, z);
                group.add(leg);
            });
            return group;
        }

        function createStripedRug() {
            const group = new THREE.Group();
            const colors = [0xc9a227, 0x8b6914, 0xc9a227, 0x8b6914, 0xc9a227];
            const stripeWidth = 0.6;
            colors.forEach((color, i) => {
                const stripe = new THREE.Mesh(
                    new THREE.BoxGeometry(stripeWidth, 0.02, 2.5),
                    new THREE.MeshLambertMaterial({ color })
                );
                stripe.position.set((i - 2) * stripeWidth, 0.01, 0);
                group.add(stripe);
            });
            return group;
        }

        function createTablecloth(color) {
            const group = new THREE.Group();
            const cloth = new THREE.Mesh(
                new THREE.BoxGeometry(2.1, 0.02, 0.9),
                new THREE.MeshLambertMaterial({ color })
            );
            cloth.position.set(0, 0.74, 0);
            group.add(cloth);
            return group;
        }

        function createFloorLamp() {
            const group = new THREE.Group();
            const mat = new THREE.MeshLambertMaterial({ color: 0xf5f5f5 });
            const base = new THREE.Mesh(new THREE.CylinderGeometry(0.15, 0.18, 0.03, 16), mat);
            base.position.set(0, 0.015, 0);
            group.add(base);
            const pole = new THREE.Mesh(new THREE.CylinderGeometry(0.02, 0.02, 1.5, 8), mat);
            pole.position.set(0, 0.78, 0);
            group.add(pole);
            const shade = new THREE.Mesh(
                new THREE.ConeGeometry(0.2, 0.25, 16, 1, true),
                new THREE.MeshLambertMaterial({ color: 0xf5f5dc, side: THREE.DoubleSide })
            );
            shade.position.set(0, 1.6, 0);
            shade.rotation.x = Math.PI;
            group.add(shade);
            return group;
        }

        function createDiscoBall() {
            const group = new THREE.Group();
            const ball = new THREE.Mesh(
                new THREE.SphereGeometry(0.15, 16, 16),
                new THREE.MeshLambertMaterial({ color: 0xc0c0c0 })
            );
            ball.position.set(0, 0, 0);
            group.add(ball);
            const cord = new THREE.Mesh(
                new THREE.CylinderGeometry(0.01, 0.01, 0.5, 8),
                new THREE.MeshLambertMaterial({ color: 0x333333 })
            );
            cord.position.set(0, 0.25, 0);
            group.add(cord);
            return group;
        }

        function createSmallPlant() {
            const group = new THREE.Group();
            const pot = new THREE.Mesh(
                new THREE.CylinderGeometry(0.08, 0.06, 0.12, 12),
                new THREE.MeshLambertMaterial({ color: 0x8b4513 })
            );
            pot.position.set(0, 0.06, 0);
            group.add(pot);
            const plant = new THREE.Mesh(
                new THREE.SphereGeometry(0.1, 8, 8),
                new THREE.MeshLambertMaterial({ color: 0x32cd32 })
            );
            plant.position.set(0, 0.18, 0);
            group.add(plant);
            return group;
        }

        function createVase() {
            const group = new THREE.Group();
            const vase = new THREE.Mesh(
                new THREE.CylinderGeometry(0.08, 0.12, 0.25, 12),
                new THREE.MeshLambertMaterial({ color: 0x4169e1 })
            );
            vase.position.set(0, 0.125, 0);
            group.add(vase);
            const flowers = new THREE.Mesh(
                new THREE.SphereGeometry(0.12, 8, 8),
                new THREE.MeshLambertMaterial({ color: 0xff69b4 })
            );
            flowers.position.set(0, 0.35, 0);
            group.add(flowers);
            return group;
        }

        function createWallPoster(color, width, height, text) {
            const group = new THREE.Group();
            const poster = new THREE.Mesh(
                new THREE.BoxGeometry(width, height, 0.02),
                new THREE.MeshLambertMaterial({ color })
            );
            poster.position.set(0, height/2, 0);
            group.add(poster);
            // Frame
            const frameMat = new THREE.MeshLambertMaterial({ color: 0x1a1a1a });
            const frameT = new THREE.Mesh(new THREE.BoxGeometry(width + 0.04, 0.02, 0.03), frameMat);
            frameT.position.set(0, height + 0.01, 0.01);
            group.add(frameT);
            const frameB = new THREE.Mesh(new THREE.BoxGeometry(width + 0.04, 0.02, 0.03), frameMat);
            frameB.position.set(0, -0.01, 0.01);
            group.add(frameB);
            const frameL = new THREE.Mesh(new THREE.BoxGeometry(0.02, height + 0.04, 0.03), frameMat);
            frameL.position.set(-width/2 - 0.01, height/2, 0.01);
            group.add(frameL);
            const frameR = new THREE.Mesh(new THREE.BoxGeometry(0.02, height + 0.04, 0.03), frameMat);
            frameR.position.set(width/2 + 0.01, height/2, 0.01);
            group.add(frameR);
            group.userData.isWallArt = true;
            return group;
        }

        function createTextBanner(text, bgColor, textColor = 0xffffff) {
            const group = new THREE.Group();
            const banner = new THREE.Mesh(
                new THREE.BoxGeometry(0.8, 1.0, 0.02),
                new THREE.MeshLambertMaterial({ color: bgColor })
            );
            banner.position.set(0, 0.5, 0);
            group.add(banner);
            group.userData.isWallArt = true;
            group.userData.bannerText = text;
            return group;
        }

        // Place item in scene
        container.addEventListener('click', function(event) {
            if (!decoratorMode || !selectedFurnitureType) return;

            const rect = container.getBoundingClientRect();
            mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);

            // Check if clicking on existing item
            const itemIntersects = raycaster.intersectObjects(placedItems, true);
            if (itemIntersects.length > 0) {
                let obj = itemIntersects[0].object;
                while (obj.parent && !obj.userData.isPlacedItem) obj = obj.parent;
                if (obj.userData.isPlacedItem) {
                    selectedPlacedItem = obj;
                    selectedFurnitureType = null;
                    document.querySelectorAll('.item-card').forEach(c => c.classList.remove('selected'));
                    updateSelectedInfo();
                    return;
                }
            }

            // Place new item on floor
            const floorPlane = new THREE.Plane(new THREE.Vector3(0, 1, 0), 0);
            const intersectPoint = new THREE.Vector3();
            raycaster.ray.intersectPlane(floorPlane, intersectPoint);

            if (intersectPoint) {
                const item = createFurnitureItem(selectedFurnitureType);
                item.position.copy(intersectPoint);

                // Wall art needs to be placed on walls
                if (item.userData.isWallArt) {
                    item.position.y = 1.5;
                }

                scene.add(item);
                placedItems.push(item);
            }
        });

        window.moveItem = function(dx, dz) {
            if (selectedPlacedItem) {
                selectedPlacedItem.position.x += dx;
                selectedPlacedItem.position.z += dz;
            }
        };

        window.rotateItem = function(degrees) {
            if (selectedPlacedItem) {
                selectedPlacedItem.rotation.y += degrees * Math.PI / 180;
            }
        };

        window.deleteItem = function() {
            if (selectedPlacedItem) {
                scene.remove(selectedPlacedItem);
                placedItems = placedItems.filter(i => i !== selectedPlacedItem);
                selectedPlacedItem = null;
                updateSelectedInfo();
            }
        };

        window.saveLayout = async function() {
            const layout = placedItems.map(item => ({
                type: item.userData.itemType,
                position: { x: item.position.x, y: item.position.y, z: item.position.z },
                rotation: { y: item.rotation.y }
            }));

            // Save to localStorage as backup
            localStorage.setItem('panafricanLibraryLayout', JSON.stringify(layout));

            // Also save to Vercel Blob for persistent shared storage
            try {
                const response = await fetch('/api/layout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(layout)
                });
                const result = await response.json();
                if (result.success) {
                    alert('Layout saved! This layout will be visible to all visitors.');
                } else {
                    alert('Layout saved locally. Cloud sync failed: ' + (result.error || 'Unknown error'));
                }
            } catch (err) {
                console.error('Cloud save error:', err);
                alert('Layout saved locally. Cloud sync unavailable.');
            }
        };

        window.loadLayout = async function() {
            try {
                // First try to load from Vercel Blob (shared layout)
                const response = await fetch('/api/layout');
                const result = await response.json();

                if (result.success && result.layout && result.layout.length > 0) {
                    applyLayout(result.layout);
                    alert('Shared layout loaded from cloud!');
                    return;
                }
            } catch (err) {
                console.error('Cloud load error:', err);
            }

            // Fallback to localStorage
            const saved = localStorage.getItem('panafricanLibraryLayout');
            if (saved) {
                const layout = JSON.parse(saved);
                applyLayout(layout);
                alert('Layout loaded from local storage.');
            } else {
                alert('No saved layout found.');
            }
        };

        function applyLayout(layout) {
            // Clear existing placed items
            placedItems.forEach(item => scene.remove(item));
            placedItems = [];
            // Recreate items
            layout.forEach(data => {
                const item = createFurnitureItem(data.type);
                item.position.set(data.position.x, data.position.y, data.position.z);
                item.rotation.y = data.rotation.y;
                scene.add(item);
                placedItems.push(item);
            });
        }

        // Auto-load shared layout on page load
        async function autoLoadLayout() {
            try {
                const response = await fetch('/api/layout');
                const result = await response.json();

                if (result.success && result.layout && result.layout.length > 0) {
                    applyLayout(result.layout);
                    console.log('Auto-loaded shared layout from cloud');
                }
            } catch (err) {
                // Silently fail - just use empty layout
                console.log('No shared layout available');
            }
        }

        // Call autoLoadLayout after scene is ready
        setTimeout(autoLoadLayout, 1000);

        window.resetLayout = function() {
            if (confirm('Reset to default layout? This will remove all placed items.')) {
                placedItems.forEach(item => scene.remove(item));
                placedItems = [];
                deselectAll();
            }
        };

        window.exportLayout = function() {
            const layout = placedItems.map(item => ({
                type: item.userData.itemType,
                position: { x: item.position.x, y: item.position.y, z: item.position.z },
                rotation: { y: item.rotation.y }
            }));
            const blob = new Blob([JSON.stringify(layout, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'panafrican-library-layout.json';
            a.click();
        };

        // Wall visibility based on camera position
        function updateWallVisibility() {
            if (!hideNearWall) {
                // Show all walls
                Object.values(room5202Walls).forEach(w => { if (w) w.visible = true; });
                Object.values(room5203Walls).forEach(w => { if (w) w.visible = true; });
                return;
            }

            // Determine which wall is closest to camera
            const camX = camera.position.x;
            const camZ = camera.position.z;

            // Room 5202 walls
            // FRONT wall (windows) - hide when camera is in front (positive Z)
            if (room5202Walls.front) room5202Walls.front.visible = camZ < ROOM_5202_DEPTH / 4;

            // BACK wall (corridor entry) - hide when camera is behind (negative Z)
            // Also hide entire vestibule (all corridor walls) when hiding back area
            const hideBackArea = camZ < -ROOM_5202_DEPTH / 4;
            if (room5202Walls.back) room5202Walls.back.visible = !hideBackArea;
            if (room5202Walls.vestibuleGroup) room5202Walls.vestibuleGroup.visible = !hideBackArea;

            // LEFT wall (Three Star door) - hide when camera is to the left
            if (room5202Walls.left) room5202Walls.left.visible = camX > ROOM_5202_X - ROOM_5202_WIDTH / 2;

            // RIGHT wall (open passage to 5203) - hide when camera is between rooms
            if (room5202Walls.right) room5202Walls.right.visible = camX < ROOM_5202_X + ROOM_5202_WIDTH / 4;

            // Room 5203 walls
            // FRONT wall (windows) - hide when camera is in front
            if (room5203Walls.front) room5203Walls.front.visible = camZ < ROOM_5203_DEPTH / 4;

            // BACK wall (corridor entry + poster wall) - hide when camera is behind
            if (room5203Walls.back) room5203Walls.back.visible = camZ > -ROOM_5203_DEPTH / 4;

            // LEFT wall (open passage to 5202) - hide when camera is between rooms
            if (room5203Walls.left) room5203Walls.left.visible = camX > ROOM_5203_X - ROOM_5203_WIDTH / 4;

            // RIGHT wall (solid exterior) - hide when camera is to the right
            if (room5203Walls.right) room5203Walls.right.visible = camX < ROOM_5203_X + ROOM_5203_WIDTH / 2;
        }

        // Auto ceiling visibility based on camera height
        function updateCeilingVisibility() {
            const camY = camera.position.y;
            const isAbove = camY > CEILING_HEIGHT + 1;

            if (showCeiling) {
                // Auto-hide ceiling when viewing from above
                ceilingsGroup.traverse((obj) => {
                    if (obj.userData.isCeiling || obj.isMesh) {
                        obj.visible = !isAbove;
                    }
                });
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            currentRotationX += (targetRotationX - currentRotationX) * 0.05;
            currentRotationY += (targetRotationY - currentRotationY) * 0.05;

            if (keys['w']) cameraTarget.z -= 0.1;
            if (keys['s']) cameraTarget.z += 0.1;
            if (keys['a']) cameraTarget.x -= 0.1;
            if (keys['d']) cameraTarget.x += 0.1;

            camera.position.x = cameraTarget.x + Math.sin(currentRotationX) * Math.cos(currentRotationY) * cameraDistance;
            camera.position.y = cameraTarget.y + Math.sin(currentRotationY) * cameraDistance;
            camera.position.z = cameraTarget.z + Math.cos(currentRotationX) * Math.cos(currentRotationY) * cameraDistance;
            camera.lookAt(cameraTarget);

            updateWallVisibility();
            updateCeilingVisibility();

            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
